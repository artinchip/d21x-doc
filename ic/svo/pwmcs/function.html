

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>14.1.2. 功能描述 &mdash; AIC文档中心 v1.0 文档</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme_overrides.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/aic_logo.png"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/translations.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="索引" href="../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../search.html" />
    <link rel="next" title="14.1.3. 寄存器描述" href="register.html" />
    <link rel="prev" title="14.1.1. 概述" href="overview.html" />
    <script>
        $(function () {
/**
            var $body = $(".rst-content");
            $body.attr("oncontextmenu", "return false"); 
            $body.attr("ondragstart", "return false");
            $body.attr("onselectstart", "return false");
            $body.attr("onbeforecopy", "return false");

            if (document.selection) {
                $body.attr("onselect", "document.selection.empty()");
                $body.attr("oncopy", "document.selection.empty()");
                $body.attr("onmouseup", "document.selection.empty()");
            } else {
                $body.attr("onselect", "document.getSelection().removeAllRanges()");
                $body.attr("oncopy", "document.getSelection().removeAllRanges()");
                $body.attr("onmouseup", "document.getSelection().removeAllRanges()");
            }

            $(".wy-menu-vertical .toctree-l4.current .current.toctree-l5 > ul").wrap("<div></div>");

            $(document).keydown(function (e) {
                var $div = $(".wy-menu-vertical .toctree-l4.current .current.toctree-l5 > div");
                var scrollLeft = $div.scrollLeft();
                var step = 50;
                var code = e.keyCode;
                switch (code) {
                    case 37:
                        $div.scrollLeft(scrollLeft - step);
                        break;
                    case 39:
                        $div.scrollLeft(scrollLeft + step);
                        break;
                    case 65:
                    case 67:
                    case 83:
                    case 86:
                        var ctrlKey = navigator.platform.match("Mac") ? e.metaKey : e.ctrlKey;
                        if (ctrlKey) {
                            e.preventDefault();
                            window.event.returnValue = false;
                        }
                        break;
                    case 123:
                        e.preventDefault();
                        window.event.returnValue = false;
                        break;
                }
	    });  **/

            watermark({
                watermark_id: ".wy-nav-content",
                watermark_txt: "ArtInChip",
                watermark_font: "微软雅黑",
                watermark_fontsize: "100px",
                watermark_width: 600,
                watermark_height: 300,
                watermark_alpha: 0.1,
                watermark_rows: 0,
                watermark_y: 100,
                watermark_x_space: 0,
                watermark_y_space: 100
            });

        });

        function watermark(settings) {
            var defaultSettings = {
                watermark_id: "body",
                watermark_txt: "text",
                watermark_x: 20,
                watermark_y: 20,
                watermark_rows: 20,
                watermark_cols: 20,
                watermark_x_space: 100,
                watermark_y_space: 50,
                watermark_color: '#aaa',
                watermark_alpha: 0.4,
                watermark_fontsize: '15px',
                watermark_font: 'Times New Roman',
                watermark_width: 210,
                watermark_height: 80,
                watermark_angle: 20
            };

            for (key in settings) {
                defaultSettings[key] = settings[key];
            }

            var oTemp = document.createDocumentFragment();

            var $container = $(defaultSettings.watermark_id);

            var page_width = $container.width();
            var col_width = defaultSettings.watermark_width + defaultSettings.watermark_x_space;
            defaultSettings.watermark_cols = page_width / col_width;

            var page_height = $container.height();
            var row_height = defaultSettings.watermark_height + defaultSettings.watermark_y_space;
            defaultSettings.watermark_rows = page_height / row_height;

            var x, y;
            for (var i = 0; i < defaultSettings.watermark_rows; i++) {
                y = defaultSettings.watermark_y + (defaultSettings.watermark_y_space + defaultSettings.watermark_height) * i;
                for (var j = 0; j < defaultSettings.watermark_cols; j++) {
                    x = defaultSettings.watermark_x + (defaultSettings.watermark_width + defaultSettings.watermark_x_space) * j;
                    var mask_div = document.createElement('div');
                    mask_div.id = 'mask_div' + i + j;
                    mask_div.className = 'mask_div';
                    mask_div.appendChild(document.createTextNode(defaultSettings.watermark_txt));

                    mask_div.style.webkitTransform = "rotate(-" + defaultSettings.watermark_angle + "deg)";
                    mask_div.style.MozTransform = "rotate(-" + defaultSettings.watermark_angle + "deg)";
                    mask_div.style.msTransform = "rotate(-" + defaultSettings.watermark_angle + "deg)";
                    mask_div.style.OTransform = "rotate(-" + defaultSettings.watermark_angle + "deg)";
                    mask_div.style.transform = "rotate(-" + defaultSettings.watermark_angle + "deg)";
                    mask_div.style.visibility = "";
                    mask_div.style.position = "absolute";
                    mask_div.style.left = x + 'px';
                    mask_div.style.top = y + 'px';
                    mask_div.style.overflow = "hidden";
                    mask_div.style.zIndex = "9999";

                    mask_div.style.pointerEvents = 'none';
                    mask_div.style.opacity = defaultSettings.watermark_alpha;
                    mask_div.style.fontSize = defaultSettings.watermark_fontsize;
                    mask_div.style.fontFamily = defaultSettings.watermark_font;
                    mask_div.style.color = defaultSettings.watermark_color;
                    mask_div.style.textAlign = "center";
                    mask_div.style.width = defaultSettings.watermark_width + 'px';
                    mask_div.style.height = defaultSettings.watermark_height + 'px';
                    mask_div.style.display = "block";
                    oTemp.appendChild(mask_div);
                };
            };
            $container.append(oTemp);
        }
    </script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> AIC文档中心
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../product/index.html">产品简介</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../quick-start/index.html">快速入门</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../datasheet/index.html">数据手册</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">芯片手册</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../about/index.html">1. 文档说明</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../introduction/index.html">2. 产品描述</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../memory_maps/index.html">3. 地址映射</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../pinmux/index.html">4. 引脚复用</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cpu_bus/index.html">5. 处理器和总线</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../security/index.html">6. 安全</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../brom/index.html">7. 启动</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../clocks_power/index.html">8. 时钟和电源</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../memory/index.html">9. 存储</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../media/index.html">10. 多媒体</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../timers/index.html">11. 计时器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../interface/index.html">12. 接口</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../analog/index.html">13. 模拟</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">14. 伺服系统</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="index.html">14.1. Pulse Width Modulation Control System (PWMCS)</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="overview.html">14.1.1. 概述</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">14.1.2. 功能描述</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#pwm">14.1.2.1. PWM子模块</a><ul>
<li class="toctree-l6"><a class="reference internal" href="#id2">14.1.2.1.1. 结构框图</a></li>
<li class="toctree-l6"><a class="reference internal" href="#id3">14.1.2.1.2. 计数器功能模块</a></li>
<li class="toctree-l6"><a class="reference internal" href="#id4">14.1.2.1.3. PWM生成模块</a></li>
<li class="toctree-l6"><a class="reference internal" href="#pwm-chopper">14.1.2.1.4. PWM Chopper模块</a></li>
<li class="toctree-l6"><a class="reference internal" href="#id5">14.1.2.1.5. PWM保护模块</a></li>
<li class="toctree-l6"><a class="reference internal" href="#adc">14.1.2.1.6. ADC采样触发和中断模块</a></li>
<li class="toctree-l6"><a class="reference internal" href="#id6">14.1.2.1.7. 输入信号过滤</a></li>
</ul>
</li>
<li class="toctree-l5"><a class="reference internal" href="#cap">14.1.2.2. CAP子模块</a><ul>
<li class="toctree-l6"><a class="reference internal" href="#id7">14.1.2.2.1. 结构框图</a></li>
<li class="toctree-l6"><a class="reference internal" href="#id8">14.1.2.2.2. 计数器功能</a></li>
<li class="toctree-l6"><a class="reference internal" href="#id9">14.1.2.2.3. 捕捉输入功能</a></li>
<li class="toctree-l6"><a class="reference internal" href="#id10">14.1.2.2.4. 简单PWM输出功能</a></li>
<li class="toctree-l6"><a class="reference internal" href="#id11">14.1.2.2.5. 中断信号</a></li>
</ul>
</li>
<li class="toctree-l5"><a class="reference internal" href="#qep">14.1.2.3. QEP子模块</a><ul>
<li class="toctree-l6"><a class="reference internal" href="#id12">14.1.2.3.1. 结构框图</a></li>
<li class="toctree-l6"><a class="reference internal" href="#id13">14.1.2.3.2. 正交解码</a></li>
<li class="toctree-l6"><a class="reference internal" href="#id14">14.1.2.3.3. 正交位置计数功能</a></li>
<li class="toctree-l6"><a class="reference internal" href="#id15">14.1.2.3.4. 正交时间捕捉功能</a></li>
<li class="toctree-l6"><a class="reference internal" href="#qep-timer">14.1.2.3.5. QEP Timer</a></li>
<li class="toctree-l6"><a class="reference internal" href="#qep-watchdog-timer">14.1.2.3.6. QEP Watchdog Timer</a></li>
<li class="toctree-l6"><a class="reference internal" href="#qep-hall-monitor">14.1.2.3.7. QEP Hall Monitor</a></li>
<li class="toctree-l6"><a class="reference internal" href="#id16">14.1.2.3.8. 中断</a></li>
</ul>
</li>
<li class="toctree-l5"><a class="reference internal" href="#id17">14.1.2.4. 全局控制</a><ul>
<li class="toctree-l6"><a class="reference internal" href="#id18">14.1.2.4.1. 全局时钟控制</a></li>
<li class="toctree-l6"><a class="reference internal" href="#id19">14.1.2.4.2. 全局中断</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="register.html">14.1.3. 寄存器描述</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../psadc/index.html">14.2. PWM System ADC (PSADC)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../verify/index.html">15. 验证</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../hw/index.html">硬件指南</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../luban/index.html">Linux SDK</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../lite/index.html">RTOS SDK</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../baremetal/index.html">Baremetal</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tools/index.html">工具指南</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../3rdapp/index.html">三方应用</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../aboutus/index.html">关于我们</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">AIC文档中心</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">芯片手册</a> &raquo;</li>
        
          <li><a href="../index.html"><span class="section-number">14. </span>伺服系统</a> &raquo;</li>
        
          <li><a href="index.html"><span class="section-number">14.1. </span>PWMCS</a> &raquo;</li>
        
      <li><span class="section-number">14.1.2. </span>功能描述</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="id1">
<h1><span class="section-number">14.1.2. </span>功能描述<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h1>
<div class="section" id="pwm">
<h2><span class="section-number">14.1.2.1. </span>PWM子模块<a class="headerlink" href="#pwm" title="永久链接至标题">¶</a></h2>
<p>说明：</p>
<ul class="simple">
<li><p>PWM子模块PWM_S0/1/2/3/4/5为相同模块，以下的说明中，各个模块的信号都是相同的，但有些地方会以增加标号0/1/2/3/4/5，用于区分不同子模块的信号。例如CNT_CLK0代表PWM_S0的计数器时钟信号CNT_CLK。</p></li>
</ul>
<div class="section" id="id2">
<h3><span class="section-number">14.1.2.1.1. </span>结构框图<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h3>
<div class="figure align-left">
<img alt="../../../_images/block.png" src="../../../_images/block.png" />
</div>
<ul class="simple">
<li><p>上图所示为PWM_S0的结构框图，PWM_S0与PWM_S1/../5的结构基本一致，区别在于PWM0的同步输入输出信号PWM0_SYNCI以及PWM0_SYNCO通过GIPO MUX模块输出，而PWM_S1/../5同步输入输出信号用于内部模块，连接方式参考 计数同步 章节。</p></li>
<li><p>PWM_FLT0/1/2/3/4/5输入信号共用于所有的PWM子模块，用于可恢复和不可恢复的故障输入指示。</p></li>
<li><p>Counter Function模块，为计数器的功能模块，负责计数器计数、计数器同步、计数器比较等功能。</p></li>
<li><p>PWM Generator模块，为PWM的生成模块，负责PWM脉宽控制、PWM死区控制等功能。</p></li>
<li><p>PWM Fault模块，为PWM故障控制模块，负责在故障信号生效的时候实施保护功能以及产生中断。</p></li>
<li><p>Trigger &amp; Interrupt模块，为ADC触发信号以及中断信号的产生模块。</p></li>
</ul>
</div>
<div class="section" id="id3">
<h3><span class="section-number">14.1.2.1.2. </span>计数器功能模块<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h3>
<ol class="arabic">
<li><p>计数时钟</p>
<blockquote>
<div><p>计数器的时钟由SYS_CLK进行分频得出PWM_CNT_CLK，PWM_CNT_CLK = SYS_CLK / (Divisor1 * Divisor2)，这里的Divisor1/2 为寄存器PWM_CLK_DIV1/2。而SYS_CLK经过Divisor1得到的PWM_XADC_CLK用于控制外部触发ADC转换的信号长度。</p>
<p>除数Divisor1的可配置范围为1/2/4/6/8/10/12/14，除数Divisor2的可配置范围为1/2/4/8/16/32/64/128。</p>
<p>另外，为了确保PWM_S0/S1/S2三个子模块的计数时钟可以同步，需要一个全局的控制信号PWM_CNT_GLB_EN。同步的方式如下：</p>
<ul class="simple">
<li><p>PWM_CNT_GLB_EN = 0，关闭所有的PWM子模块的功能</p></li>
<li><p>配置各个PWM子模块的各自参数</p></li>
<li><p>使能各个PWM子模块</p></li>
<li><p>PWM_CNT_GLB_EN = 1，打开所有使能的PWM子模块的计数功能，计数器开始计数。</p></li>
</ul>
<p>为了获得较好的时钟同步效果，各个使能的PWM子模块需要配置相同的计数器时钟分频系统。</p>
</div></blockquote>
</li>
<li><p>计数方式</p>
<blockquote>
<div><p>通过寄存器字段PWM_CNT_MOD配置，可以对计数器的计数方式进行选择，计数方式有：递增计数、递减计数、先递增后递减计数模式。</p>
<ul>
<li><p>递增计数</p>
<blockquote>
<div><p>计数器从0开始递增计数，计数至PWM_CNT_PRDV值时，完成一个周期的计数，并且复位至0重新开始计数。</p>
<p>如下图所示，设置PWM_CNT_PRDV = 6的递增计数，此时进行从0到6的递增计数，在计数值为0的时候，信号PWM_CNT_Z = 1；在计数值为PWM_CNT_PRDV的时候，信号PWM_CNT_PRD = 1；而指示计数方向的信号PWM_CNTD一直为高电平，指示为递增计数。</p>
<blockquote>
<div><div class="figure align-center" id="id20">
<img alt="../../../_images/coun+.png" src="../../../_images/coun+.png" />
<p class="caption"><span class="caption-number">图 14.1 </span><span class="caption-text">计数器递增计数</span><a class="headerlink" href="#id20" title="永久链接至图片">¶</a></p>
</div>
</div></blockquote>
</div></blockquote>
</li>
<li><p>递减计数</p>
<blockquote>
<div><p>计数器从PWM_CNT_PRDV开始递减计数，计数至0时，完成一个周期的计数，并且复位至PWM_CNT_PRDV重新开始计数。</p>
<p>如下图所示，设置PWM_CNT_PRDV = 6的递减计数，此时进行从6到0递减计数，在计数值为0的时候，信号PWM_CNT_Z = 1；在计数值为PWM_CNT_PRDV的时候，信号PWM_CNT_PRD = 1；而指示计数方向的信号PWM_CNTD一直为低电平，指示为递减计数。</p>
<blockquote>
<div><div class="figure align-center" id="id21">
<img alt="../../../_images/coun-.png" src="../../../_images/coun-.png" />
<p class="caption"><span class="caption-number">图 14.2 </span><span class="caption-text">计数器递减计数</span><a class="headerlink" href="#id21" title="永久链接至图片">¶</a></p>
</div>
</div></blockquote>
</div></blockquote>
</li>
<li><p>先递增后递减计数</p>
<blockquote>
<div><p>计数器从0开始递增计数，计数至PWM_CNT_PRDV后进行递减计数，当计数器计数为1，完成一个周期的计数。下一个周期继续从0开始进行先递增后递减计数。</p>
<p>如下图所示，设置PWM_CNT_PRDV = 6的先递增再递减计数，此时进行先从0到6的递增计数再从6到0的递减计数，在计数值为0的时候，信号PWM_CNT_Z = 1；在计数值为PWM_CNT_PRDV的时候，信号PWM_CNT_PRD = 1；而指示计数方向的信号PWM_CNTD在前半周期为高电平指示此时为递增计数，后半周期指示为递减计数。</p>
<blockquote>
<div><div class="figure align-center" id="id22">
<img alt="../../../_images/coun+-.png" src="../../../_images/coun+-.png" />
<p class="caption"><span class="caption-number">图 14.3 </span><span class="caption-text">计数器先递增后递减计数</span><a class="headerlink" href="#id22" title="永久链接至图片">¶</a></p>
</div>
</div></blockquote>
</div></blockquote>
</li>
</ul>
</div></blockquote>
</li>
<li><p>计数比较</p>
<blockquote>
<div><p>计数器在计数数值达到预设的设定值（PWM_CNT_AV与PWM_CNT_BV），可以产生相应的信号PWM_CNT_A与PWM_CNT_B，具体的时序例子可见下图。</p>
<p>另外，为了区分计数的方向，若为递增计数至PWM_CNT_AV产生的信号记为PWM_CNT_UA，若为递减计数至PWM_CNT_AV产生的信号记为PWM_CNT_DA。</p>
<p>同样若递增计数至PWM_CNT_BV产生的信号记为PWM_CNT_UB，若为递减计数至PWM_CNT_BV产生的信号记为PWM_CNT_DB。</p>
<p>这里产生的信号输出至PWM生成模块以及Trigger &amp; Interrupt模块使用。</p>
<blockquote>
<div><div class="figure align-center" id="id23">
<img alt="../../../_images/coun+c.png" src="../../../_images/coun+c.png" />
<p class="caption"><span class="caption-number">图 14.4 </span><span class="caption-text">递增计数产生比较信号</span><a class="headerlink" href="#id23" title="永久链接至图片">¶</a></p>
</div>
<div class="figure align-center" id="id24">
<img alt="../../../_images/coun-c.png" src="../../../_images/coun-c.png" />
<p class="caption"><span class="caption-number">图 14.5 </span><span class="caption-text">递减计数产生比较信号</span><a class="headerlink" href="#id24" title="永久链接至图片">¶</a></p>
</div>
<div class="figure align-center" id="id25">
<img alt="../../../_images/coun+-c.png" src="../../../_images/coun+-c.png" />
<p class="caption"><span class="caption-number">图 14.6 </span><span class="caption-text">先递增后递减计数产生比较信号</span><a class="headerlink" href="#id25" title="永久链接至图片">¶</a></p>
</div>
</div></blockquote>
</div></blockquote>
</li>
<li><p>计数同步</p>
<blockquote>
<div><p>计数器具有同步的功能，同步信号的使能后，可以使得计数器计数值跳至PWM_CNT_PHV计数同步相位寄存器的数值。</p>
<p>计数器的同步信号的来源有两个，一个是IN_SYNC，一个是SW_SYNC。</p>
<ul class="simple">
<li><p>IN_SYNC，对于PWM子模块，是外部输入信号，子模块PWM_S0为通过GPIO MUX复用选通连接的外部输入信号PWM0_SYNCI。</p></li>
<li><p>SW_SYNC，为PWM子模块通过寄存器设置PWM_SW_FRC_SYNC位而产生，即是软件控制产生。</p></li>
<li><p>IN_SYNC与SW_SYNC的信号经过或逻辑后，决定计数器的同步。</p></li>
</ul>
<p>另外计数器还会产生输出的同步信号OUT_SYNC，此信号可以通过寄存器设置，选择不同的信号作为OUT_SYNC。OUT_SYNC的来源如图9.10所示。</p>
<blockquote>
<div><div class="figure align-center" id="id26">
<img alt="../../../_images/output.png" src="../../../_images/output.png" />
<p class="caption"><span class="caption-number">图 14.7 </span><span class="caption-text">同步输出信号源</span><a class="headerlink" href="#id26" title="永久链接至图片">¶</a></p>
</div>
</div></blockquote>
<p>PWM子模块利用上述的输入同步信号以及输出同步信号，可以将PWM子模块S0/S1/S2/S3/S4/S5进行计数器的相位同步。各个模块的同步连接方式如下（其中PWM_S0的输出同步信号需通过GPIO_MUX输出给外部器件）：</p>
<blockquote>
<div><div class="figure align-center" id="id27">
<img alt="../../../_images/outputnet.png" src="../../../_images/outputnet.png" />
<p class="caption"><span class="caption-number">图 14.8 </span><span class="caption-text">同步信号网络</span><a class="headerlink" href="#id27" title="永久链接至图片">¶</a></p>
</div>
</div></blockquote>
</div></blockquote>
</li>
<li><p>寄存器更新</p>
<blockquote>
<div><p>寄存器PWM_CNT_PRDV以及PWM_CNT_AV、PWM_CNT_BV的更新支持 立即更新模式 以及 影子寄存器更新 模式。这三个寄存器各有独立控制的更新模式的控制位。</p>
<ul class="simple">
<li><p>立即更新模式</p></li>
</ul>
<p>此模式下，对寄存器PWM_CNT_PRDV以及PWM_CNT_AV、PWM_CNT_BV的数值的写入，会立即生效，影响当前的PWM生成。</p>
<ul class="simple">
<li><p>影子寄存器更新模式</p></li>
</ul>
<p>此模式下，寄存器PWM_CNT_PRDV以及PWM_CNT_AV、PWM_CNT_BV的数值的写入，暂时存入各自的影子寄存器，不会立即生效，只有当计数器计数值复位至0时才进行更新，把影子寄存器的数值生效。</p>
<p>影子寄存器更新模式如下图所示，在PWM_CNT_BV的数值进行写操作从0x2改变为0x4后，并没有立即生效，而是在计数值复位至0开始下一个周期的计数后，PWM_CNT_BV的数值才生效，从而改变了PWM信号的占空比。</p>
<div class="figure align-center" id="id28">
<img alt="../../../_images/PWMCNTBV.png" src="../../../_images/PWMCNTBV.png" />
<p class="caption"><span class="caption-number">图 14.9 </span><span class="caption-text">PWM_CNT_BV影子寄存器更新</span><a class="headerlink" href="#id28" title="永久链接至图片">¶</a></p>
</div>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="id4">
<h3><span class="section-number">14.1.2.1.3. </span>PWM生成模块<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h3>
<p>PWM生成模块，可以产生A、B两个通道的PWM信号。</p>
<p>利用信号PWM_CNT_Z、PWM_CNT_PRD、PWM_CNT_UAV、PWM_CNT_DAV、PWM_CNT_UBV和PWM_CNT_DBV，根据寄存器配置PWM的输出模式，生成PWM信号PWM_SA、PWM_SB。</p>
<blockquote>
<div><div class="figure align-center" id="id29">
<img alt="../../../_images/inblock.png" src="../../../_images/inblock.png" />
<p class="caption"><span class="caption-number">图 14.10 </span><span class="caption-text">PWM生成模块的内部框图</span><a class="headerlink" href="#id29" title="永久链接至图片">¶</a></p>
</div>
</div></blockquote>
<p>如上图所示，PWM生成模块的内部由PWM动作控制模块、PWM输出模块、PWM Chopper模块</p>
<ol class="arabic">
<li><p>动作控制</p>
<blockquote>
<div><p>触发产生PWM动作的信号为计数器功能模块产生的信号：</p>
<ul class="simple">
<li><p>PWM_CNT_Z，计数器数值达到0时产生；</p></li>
<li><p>PWM_CNT_PRD ，计数器数值达到PWM_CNT_PRDV时产生；</p></li>
<li><p>PWM_CNT_UAV，计数器递增计数达到PWM_CNT_AV时产生；</p></li>
<li><p>PWM_CNT_DAV，计数器递减计数达到PWM_CNT_AV时产生；</p></li>
<li><p>PWM_CNT_UBV，计数器递增计数达到PWM_CNT_BV时产生；</p></li>
<li><p>PWM_CNT_DBV，计数器递减计数达到PWM_CNT_BV时产生；</p></li>
</ul>
<p>所有的信号对A、B通道均有效。</p>
<p>PWM_CNT_UBV/DBV所触发的动作优先级最高，其次时PWM_CNT_UAV/DBV所触发的动作。在PWM_CNT_UBV/DBV所触发的动作为无动作时，控制器则跳过CMPB的动作控制，进行PWM_CNT_UAV/DBVd的动作控制。</p>
<p>通过寄存器PWMA_ACT、PWMB_ACT配置，可以在上述的信号上执行以下的动作的类型：</p>
<ul class="simple">
<li><p>置1：PWM输出信号设置为高电平；</p></li>
<li><p>置0：PWM输出信号设置为低电平；</p></li>
<li><p>翻转：PWM输出信号进行翻转，若当前信号为高，那么动作执行将PWM信号设置为低电平；</p></li>
<li><p>无操作：PWM输出信号无变化，维持现有的信号。</p></li>
</ul>
<p>对PWM_CHA的动作做以下的设定，可以得出下图所示的PWM信号：</p>
<ul>
<li><p>计数器递增计数，PWM_CNT_BV = 0x2，PWM_CNT_PRD = 0x6；</p></li>
<li><p>PWM_CHA的动作设定，PWMA_ACT_CNTZ = 0x2 (置1)，PWM_ACT_CNTUBV = 0x1 (置0)，其他的动作设定则为无动作，那么则可以生成为占空比则为2/7 ≈ 28.5%。</p>
<blockquote>
<div><div class="figure align-center" id="id30">
<img alt="../../../_images/PWMCHA.png" src="../../../_images/PWMCHA.png" />
<p class="caption"><span class="caption-number">图 14.11 </span><span class="caption-text">PWM_CHA的生成（PWMA_ACT_CNTZ = 0x2，PWMA_ACT_CNTUBV = 0x1）</span><a class="headerlink" href="#id30" title="永久链接至图片">¶</a></p>
</div>
</div></blockquote>
</li>
</ul>
</div></blockquote>
</li>
<li><dl>
<dt>软件强制控制信号</dt><dd><p>软件强制控制信号，有两种类型的软件控制信号，一种是 非持续的软件强制控制 信号，一种是 持续的软件强制控制 信号。</p>
<ul class="simple">
<li><p>非持续的软件强制控制信号</p></li>
</ul>
<p>此类型的信号，是非持续性的，若有下一个动作控制信号出现，那么则由下个控制信号控制PWM的动作。控制PWM动作的类型包括置1、置0、翻转和无操作。</p>
<ul class="simple">
<li><p>持续的软件强制控制信号</p></li>
</ul>
<p>此类型的信号，是持续性的，即使下一个动作控制信号出现，由于软件强制控制信号优先级最高，而且此信号为持续性的，所以屏蔽后续的控制信号，仍然由持续的软件强制控制信号控制PWM的动作。控制PWM动作的类型包括置1、置0。如需由其他信号控制PWM的动作，需要将此功能关闭。</p>
</dd>
</dl>
</li>
<li><p>动作控制信号优先级</p>
<blockquote>
<div><p>当同时出现多个动作控制信号时，执行机制按照优先级最高的控制信号进行。</p>
<p>动作控制信号中，软件强制控制信号的优先级始终最高，其他信号的优先级在不同的计数模式下，排列会有所差异，具体的优先级如下表示。</p>
<p>递增计数模式，优先级排列</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 26%" />
<col style="width: 74%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>优先级</p></th>
<th class="head"><p>递增阶段</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1（最高）</p></td>
<td><p>软件强制控制信号</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>PWM_CNT_UB/ PWM_CNT_DB</p></td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p>PWM_CNT_UA/ PWM_CNT_DA</p></td>
</tr>
<tr class="row-odd"><td><p>4</p></td>
<td><p>PWM_CNT_PRD</p></td>
</tr>
<tr class="row-even"><td><p>5（最低）</p></td>
<td><p>PWM_CNT_Z</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>软件需尽量避免PWM_CNT_BV = 0或PRD值的情况出现，因为PWM_CNT_BV对应产生的PWM_CNT_UB/PWM_CNT_DB信号会导致影响PWM_CNT_Z或PWM_CNT_PRD上本应该发生的动作。</p>
</div>
</div></blockquote>
</li>
<li><p>PWM输出模式</p>
<blockquote>
<div><p>PWM输出模式可以根据模式选择信号PWM_CH_SEL[1:0]、PWM_POL_SET[1:0]、PWM_BP_SET[1:0]进行配置，选择信号处理的路径：</p>
<ul>
<li><p>PWM_CH_SEL[1:0]，通道选择控制信号，分别选择上升沿信号处理通道的输入源，以及下降沿信号处理通道的输入源。两路的信号处理通道都可以选择PWM_CHA或PWM_CHB；</p></li>
<li><p>PWM_POL_SET[1:0]，极性选择控制信号，选择正极性或负极性的信号；</p></li>
<li><p>PWM_BP_SET[1:0]，旁通选择，PWM_BP_SET[0]可以选择旁通PWM_CHA，PWM_BP_SET[1]可以选择旁通PWM_CHB；</p>
<blockquote>
<div><div class="figure align-center" id="id31">
<img alt="../../../_images/PWMoutputmode.png" src="../../../_images/PWMoutputmode.png" />
<p class="caption"><span class="caption-number">图 14.12 </span><span class="caption-text">PWM输出模式的控制</span><a class="headerlink" href="#id31" title="永久链接至图片">¶</a></p>
</div>
</div></blockquote>
</li>
</ul>
<p>根据上述的控制信号，下面列出一些典型的PWM输出模式</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 3%" />
<col style="width: 13%" />
<col style="width: 13%" />
<col style="width: 13%" />
<col style="width: 57%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Case</p></th>
<th class="head"><p>CH_SEL0，CH_SEL1</p></th>
<th class="head"><p>POL_SET0，POL_SET1</p></th>
<th class="head"><p>BP_SET0，BP_SET1</p></th>
<th class="head"><p>说明（默认死区功能打开）</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0</p></td>
<td><p>0,0</p></td>
<td><p>0,1(1,0)</p></td>
<td><p>1,1</p></td>
<td><div class="line-block">
<div class="line">互补+死区控制的PWM_CHA输出，</div>
<div class="line">PWM_OUTA为正（负）极性，</div>
<div class="line">PWM_OUTB为负（正）极性</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>1,1</p></td>
<td><p>0,1(1,0)</p></td>
<td><p>1,1</p></td>
<td><div class="line-block">
<div class="line">互补+死区控制的PWM_CHB输出，</div>
<div class="line">PWM_OUTA为正（负）极性，</div>
<div class="line">PWM_OUTB为负（正）极性</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>x,x</p></td>
<td><p>x,x</p></td>
<td><p>0,0</p></td>
<td><div class="line-block">
<div class="line">PWM_CHA直接旁通输出至PWM_OUTA，</div>
<div class="line">PWM_CHB直接旁通输出至PWM_OUTB</div>
<div class="line">这里输出的就是两路完全独立</div>
<div class="line">的PWM信号</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>3</p></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
<li><p>PWM死区控制</p>
<blockquote>
<div><p>死区控制，分别通过对上升/下降边沿的时间进行延迟，延迟的时间通过设置寄存器PWM_RE_DZCTL和PWM_FE_DZCTL寄存器进行配置，延迟时间分别为PWM_RE_DZCTL* PWM_CNT_CLK和PWM_FE_DZCTL * PWM_CNT_CLK。</p>
<p>下图以通道PWM_CHA的信号为例，分别设置PWM_RE_DZCTL = PWM_FE_DZCTL = 1，得到如下的信号，实现上升沿/下降沿的死区时间控制为1 * Tcnt_clk。</p>
<blockquote>
<div><div class="figure align-center" id="id32">
<img alt="../../../_images/diecase.png" src="../../../_images/diecase.png" />
<p class="caption"><span class="caption-number">图 14.13 </span><span class="caption-text">PWM_CHA分别插入上升沿死区以及下降沿死区的例子</span><a class="headerlink" href="#id32" title="永久链接至图片">¶</a></p>
</div>
</div></blockquote>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="pwm-chopper">
<h3><span class="section-number">14.1.2.1.4. </span>PWM Chopper模块<a class="headerlink" href="#pwm-chopper" title="永久链接至标题">¶</a></h3>
<ol class="arabic">
<li><p>功能框图</p>
<blockquote>
<div><div class="figure align-center" id="id33">
<img alt="../../../_images/chopperblock.png" src="../../../_images/chopperblock.png" />
<p class="caption"><span class="caption-number">图 14.14 </span><span class="caption-text">PWM Chopper功能框图</span><a class="headerlink" href="#id33" title="永久链接至图片">¶</a></p>
</div>
<p>上图为PWM Chopper功能框图，PWM Chopper可以通过寄存器PWM_CHOP_EN = 0x1使能，若不使能PWM Chopper模块，PWM_FA/PWM_FB信号直接旁通到PWM_SA/PWM_SB信号。</p>
<p>PWM Chopper Control利用Oneshot产生的信号PWM_OSA/OSB，以及PCLK对PWM_FA和PWM_FB信号进行调制，从而输出调制信号PWM_SA和PWM_SB。</p>
</div></blockquote>
</li>
<li><p>PClock</p>
<blockquote>
<div><p>PClock模块用于控制产生的PCLK信号的频率以及占空比。</p>
<p>通过寄存器PWM_CHOP_FRE以及PWM_CHOP_DUTY，分别可以配置PCLK的频率的分频系数以及占空比。PCLK的占空比可以通过PWM_CHOP_DUTY进行调节，调节范围是12.5%~87.5%，每档位12.5%</p>
<p>下图以互补的死区控制的一对信号，进行了PCLK信号的调制。而PCLK的占空比调整则如图19所示。</p>
<div class="figure align-center" id="id34">
<img alt="../../../_images/PCLKPWM.png" src="../../../_images/PCLKPWM.png" />
<p class="caption"><span class="caption-number">图 14.15 </span><span class="caption-text">PCLK调制PWM信号</span><a class="headerlink" href="#id34" title="永久链接至图片">¶</a></p>
</div>
<div class="figure align-center" id="id35">
<img alt="../../../_images/dutycycle.png" src="../../../_images/dutycycle.png" />
<p class="caption"><span class="caption-number">图 14.16 </span><span class="caption-text">PCLK的占空比调整</span><a class="headerlink" href="#id35" title="永久链接至图片">¶</a></p>
</div>
</div></blockquote>
</li>
<li><dl>
<dt>One-Shot</dt><dd><p>Oneshot模块产生Oneshot信号PWM_OSA和PWM_OSB，Oneshot信号以PWM_FA/FB信号的上升边沿为触发边沿，产生脉宽为PWM_CHOP_OS_WTH * PSCLK的Oneshot信号。</p>
<p>如下图所示，PWM_CHOP_OS_WTH = 0x1，产生了PWM_OSA信号，利用PMW_OSA以及PCLK信号进行调制，得出PWM_SA。</p>
<div class="figure align-center" id="id36">
<img alt="../../../_images/oneshot.png" src="../../../_images/oneshot.png" />
<p class="caption"><span class="caption-number">图 14.17 </span><span class="caption-text">PCLK以及Oneshot调制</span><a class="headerlink" href="#id36" title="永久链接至图片">¶</a></p>
</div>
</dd>
</dl>
</li>
</ol>
</div>
<div class="section" id="id5">
<h3><span class="section-number">14.1.2.1.5. </span>PWM保护模块<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h3>
<ol class="arabic">
<li><p>故障指示输入</p>
<blockquote>
<div><p>每个PWM保护模块均支持6路的故障指示输入，可以通过配置寄存器选通6路的故障输入信号（PWM_FLT0/1/2/3/4/5_IN），此6路故障输入信号经过或逻辑得到FALT_ALL信号，此信号直接控制PWM执行故障操作。另外由于PWM保护模块同时支持可恢复故障模式和不可恢复故障模式，因此存在两路的或逻辑，得到PWM_FLT_ALL0和PWM_FLT_ALL1，PWM_FLT_ALL0用于可恢复故障模式，PWM_FLT_ALL1用于不可恢复故障模式，如下图所示。</p>
<div class="figure align-center" id="id37">
<img alt="../../../_images/fault.png" src="../../../_images/fault.png" />
<p class="caption"><span class="caption-number">图 14.18 </span><span class="caption-text">PWM故障指示输入</span><a class="headerlink" href="#id37" title="永久链接至图片">¶</a></p>
</div>
</div></blockquote>
</li>
<li><p>故障操作</p>
<blockquote>
<div><p>当故障指示输入有效，那么PWM强制执行故障操作，PWM输出信号的故障操作包括：</p>
<ul class="simple">
<li><p>PWM强制输出高电平</p></li>
<li><p>PWM强制输出低电平</p></li>
<li><p>PWM强制输出高阻态</p></li>
<li><p>无操作</p></li>
</ul>
<p>另外，软件可以通过寄存器设置，强制PWM输出执行故障操作。</p>
</div></blockquote>
</li>
<li><p>故障模式</p>
<blockquote>
<div><p>PWM保护模块可以同时支持两种类型的故障模式，一种为可恢复的故障模式，另一种为不可恢复的故障模式。</p>
<ul class="simple">
<li><p>可恢复故障模式：</p></li>
</ul>
<p>此模式下，当PWM_FLT_ALL0有效，PWM模块立即执行故障操作，如果有使能中断模式，则产生PWM_RC_FALT_INT中断。当计数器计数复位至0，若PWM_FLT_ALL0信号变回无效状态吗，那么PWM的故障操作解除，PWM可以继续正常工作。</p>
<ul class="simple">
<li><p>不可恢复故障模式</p></li>
</ul>
<p>此模式下，当PWM_FLT_ALL1有效，PWM模块立即执行故障操作，如果有使能中断模式，则产生PWM_NRC_FALT_INT中断。当出现不可恢复的故障，那么此时PWM一直处于故障操作的状态，不能修改。不可恢复故障的消除，只能通过软件写寄存器消除此状态，才可以使得PWM再次正常工作。</p>
</div></blockquote>
</li>
<li><p>故障中断</p>
<blockquote>
<div><p>故障中断，由可恢复故障中断PWM_RC_FALT_INT与不可恢复中断PWM_NRC_FALT_INT进行或逻辑所得PWM_FALT_INT信号。</p>
</div></blockquote>
</li>
<li><p>PWM初始值配置</p>
<blockquote>
<div><p>通过寄存器的设置，可以配置PWM的输出信号PWM0/1/2/..5_A以及PWM0/1/2/..5_B在PWM功能未使能的情况下的初始值。</p>
<p>以PWM0_A信号为例子，在PWM_S0子模块未使能的情况下，可以有以下的情况：</p>
<ul class="simple">
<li><p>若PWM_A_INIT = 0x0，那么在PWM子模块未使能的情况下，此时PWM0_A输出的电平为低电平。</p></li>
<li><p>若PWM_A_INIT = 0x1，那么在PWM子模块未使能的情况下，此时PWM0_A输出的电平为高电平。</p></li>
<li><p>若PWM_A_INIT = 0x2/3，那么在PWM子模块未使能的情况下，此时PWM0_A输出为高阻态。</p></li>
</ul>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="adc">
<h3><span class="section-number">14.1.2.1.6. </span>ADC采样触发和中断模块<a class="headerlink" href="#adc" title="永久链接至标题">¶</a></h3>
<ol class="arabic">
<li><p>ADC采样触发</p>
<blockquote>
<div><p>PWM子模块可以通过ADC采样触发的功能，产生ADC采样使能信号，直接触发ADC进行模拟信号的采集。每个PWM子模块可以最多产生2x的ADC采样触发信号，PWM_ADC_CVRA和PWM_ADC_CVRB。</p>
<p>产生采样触发信号的输入源与控制PWM动作的信号一致，可以选择PWM_CNT_Z、PWM_CNT_PRD、PWM_CNT_UA、PWM_CNT_DA、PWM_CNT_UB、PWM_CNT_DB信号作为触发信号。</p>
<p>ADC采样触发，可以配置通过寄存器字段PWM_ADC_CVRB_DIV触发信号产生的频次，频次可配置为每次、每两次、每三次产生触发信号。以CNTZ信号为例，若配置频次为每三次，那么当出现三次的CNTZ有效信号，才会产生一次的ADC采样信号。</p>
</div></blockquote>
</li>
<li><p>PWM中断</p>
<blockquote>
<div><p>每个PWM子模块可以产生1x的PWM中断信号，此中断信号的产生也是与PWM动作的信号一致，可以选择PWM_CNT_Z、PWM_CNT_PRD、PWM_CNT_UA、PWM_CNT_DA、PWM_CNT_UB、PWM_CNT_DB信号作为中断信号PWM_INT。</p>
<p>PWM中断信号PWM_INT，同样可以通过寄存器PWM_INT_DIV字段配置信号产生的频次，频次可配置为每次、每两次、每三次产生触发信号。以CNTZ信号为例，若配置频次为每三次，那么当出现三次的CNTZ有效信号，才会产生一次的PWM中断信号。</p>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="id6">
<h3><span class="section-number">14.1.2.1.7. </span>输入信号过滤<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h3>
<p>对于保护模块的输入信号PWM_FLT0/1/2/3/4/5_IN，是经过输入信号过滤模块过滤的信号。输入信号过滤模块，用于滤除噪声信号，每路的输入信号都配置有对应的输入滤波模块，功能框图如下：</p>
<div class="figure align-center" id="id38">
<img alt="../../../_images/inputfit.png" src="../../../_images/inputfit.png" />
<p class="caption"><span class="caption-number">图 14.19 </span><span class="caption-text">输入滤波功能</span><a class="headerlink" href="#id38" title="永久链接至图片">¶</a></p>
</div>
<p>上图以PWM_FLT0信号为例，可以看出输入滤波的功能可以设置成2种模式</p>
<ul class="simple">
<li><p>同步信号输出，即通过SYS_CLK对输入信号PWM_FLT0进行同步</p></li>
<li><p>1/2/…/15采样点的同步信号输出，即同步信号经过Sample CTL模块，判定1/2/…/15个采样点为相同值的信号认为有效信号，否则认为噪声信号进行滤除</p></li>
</ul>
<p>这里对Sample CTL模块的功能进行进一步的描述：</p>
<p>Sample CTL模块的输入信号是IN Sync模块的输出信号，即SYS_SCLK对PWM_FLT0信号进行同步得出PWM_FLT0_SYNC信号。</p>
<p>通过配置Sample CTL模块的寄存器，可以配置对PWM_FLT0_SYNC信号的采样周期，采样周期为1x/2x/4x/…/510x SYSCLK。</p>
<p>通过配置寄存器，可以配置1/2/…/15采样点的同步信号输出，即以1/2/…/15个采样点的时间长度作为一个处理周期，若这个周期的采样点均为相同值则认为是有效值，那么PWM_FLT0_IN的信号输出此有效值。</p>
<p>下面以采样周期配置为2x SYSCLK、5采样点同步信号输出的配置为例，对PWM_FLT0_SYNC信号进行处理，如下图所示。在T0时刻，对PWM_FLT0_SYNC进行第一次的信号采集，采集为0信号，由于接下来采集的4次信号均为0信号，所以在第五个采样点的时候，PWM_FLT0_IN进行了翻转，输出位0信号，这样就完成一个处理周期。而在T1时刻，由于第一次采集信号为0信号，而第二次采集信号出现1信号，那么此次处理周期判定为无效值，PWM_FLT0_IN维持当前值。</p>
<div class="figure align-center" id="id39">
<img alt="../../../_images/signalout.png" src="../../../_images/signalout.png" />
<p class="caption"><span class="caption-number">图 14.20 </span><span class="caption-text">5采样点同步信号输出</span><a class="headerlink" href="#id39" title="永久链接至图片">¶</a></p>
</div>
</div>
</div>
<div class="section" id="cap">
<h2><span class="section-number">14.1.2.2. </span>CAP子模块<a class="headerlink" href="#cap" title="永久链接至标题">¶</a></h2>
<p>CAP子模块，具有捕捉模式和简单PWM输出两种模式。</p>
<p>捕捉模式是一种输入的模式，对输入的信号进行边沿的捕获，从而获得周期等时间信息。</p>
<p>简单PWM输出模式是一种输出模式，产生简单PWM信号（相对PWM子模块产生的信号）。</p>
<p>捕捉模式与PWM模式上复用相同的信号CAPx_IO(0/1/2)。</p>
<p>说明：</p>
<ul class="simple">
<li><p>CAP子模块CAP_S0/S1/S2均为相同模块，以下的说明中，各个模块的信号都是相同的，但有些地方会以增加标号0/1/2，用于区分不同子模块的信号。例如CNT_CLK0代表PWM_S0的计数器时钟信号CNT_CLK。</p></li>
</ul>
<div class="section" id="id7">
<h3><span class="section-number">14.1.2.2.1. </span>结构框图<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h3>
<div class="figure align-center" id="id40">
<img alt="../../../_images/caps0block.png" src="../../../_images/caps0block.png" />
<p class="caption"><span class="caption-number">图 14.21 </span><span class="caption-text">CAP_S0子模块结构框图</span><a class="headerlink" href="#id40" title="永久链接至图片">¶</a></p>
</div>
<ul class="simple">
<li><p>上图所示为CAP_S0的结构框图，CAP_S0与CAP_S1/2的结构基本一致；</p></li>
<li><p>CAP_S0主要由计数功能模块、PWM功能模块、捕捉功能模块和中断功能模块组成，其中PWM功能模块与捕捉功能模块是二选一功能；</p></li>
</ul>
</div>
<div class="section" id="id8">
<h3><span class="section-number">14.1.2.2.2. </span>计数器功能<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h3>
<p>捕捉模式以及简单PWM输出模式，采用相同的计数器模块，计数器为32bit计数器。</p>
<ol class="arabic">
<li><p>计数时钟</p>
<blockquote>
<div><p>CAP模块的计数器的时钟无分频系数控制，直接由SYS_CLK驱动。</p>
<p>计数器在计数值等于CAP_CNT_PRDV(即PMW模式下CAP_REG0)可产生CAP_CNT_PRD信号。</p>
<p>计数器在计数值等于CAP_CNT_CMPV(即PMW模式下CAP_REG1)可产生CAP_CNT_CMP信号。</p>
<p>在计数值达到0xFFFF_FFFF时可产生CAP_CNT_OVFL信号。</p>
</div></blockquote>
</li>
<li><p>计数同步</p>
<blockquote>
<div><p>CAP模块的计数器支持外部输入信号同步计数器，以及输出同步信号。</p>
</div></blockquote>
</li>
</ol>
<ul>
<li><p>输入同步</p>
<blockquote>
<div><p>当输入同步信号CAP_SYNCI有效，计数器将同步相位寄存器CAP_CNT_PH的数值加载至计数器，从而达到计数器相位的同步效果。另外CAP_S0/1/2的输入同步信号的连接方式，可以参考 PWM计数同步 章节描述。</p>
</div></blockquote>
</li>
<li><p>输出同步</p>
<blockquote>
<div><p>输出同步信号，通过寄存器CAP_SYNC_OUT，可以选择CAP_SYNCI信号或CAP_CNT_PRD信号输出。</p>
<div class="figure align-center" id="id41">
<img alt="../../../_images/signalsel.png" src="../../../_images/signalsel.png" />
<p class="caption"><span class="caption-number">图 14.22 </span><span class="caption-text">同步输出信号的选通</span><a class="headerlink" href="#id41" title="永久链接至图片">¶</a></p>
</div>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="id9">
<h3><span class="section-number">14.1.2.2.3. </span>捕捉输入功能<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h3>
<ol class="arabic">
<li><p>功能框图</p>
<blockquote>
<div><div class="figure align-center" id="id42">
<img alt="../../../_images/getinputblock.png" src="../../../_images/getinputblock.png" />
<p class="caption"><span class="caption-number">图 14.23 </span><span class="caption-text">捕捉输入的功能框图</span><a class="headerlink" href="#id42" title="永久链接至图片">¶</a></p>
</div>
</div></blockquote>
</li>
<li><p>输入滤波</p>
<blockquote>
<div><p>CAP子模块在捕捉输入功能下，输入信号CAP0/1/2_IO均需要经过输入滤波模块，产生CAP0/1/2_IO_PRCS信号。</p>
<p>输入滤波功能，主要是用于滤除噪音信号，功能描述可以参考PWM子模块的 输入滤波 章节描述。</p>
</div></blockquote>
</li>
<li><p>捕捉边沿预处理</p>
<blockquote>
<div><p>捕捉边沿预处理功能，通过寄存器字段CAP_IN_EDG_EVN_DIV配置对输入信号CAP_IO的边沿翻转进行处理。如设置CAP_IN_EDG_EVN_DIV = 0x1，输入信号的每两次的翻转边沿才触发1次的翻转，从而得到信号CAP_IO_DIV。这样的预处理可以降低输入信号的翻转的频次。</p>
</div></blockquote>
</li>
<li><p>捕捉事件属性</p>
<blockquote>
<div><p>捕捉事件的产生即是针对CAP_IO_DI信号的上下边沿的捕捉。</p>
<p>捕捉事件EVENT0/1/2/3可以根据需求，通过寄存器字段CAP_EVNT0/1/2/3_POL，设置事件为上升沿捕捉或下降沿捕捉，以及通过寄存器字段CAP_EVNT0/1/2/3_RST配置发生捕捉事件后是否复位计数器，这样的配置方式可以计算出两次边沿的时间差值。</p>
</div></blockquote>
</li>
<li><p>捕捉事件逻辑</p>
<blockquote>
<div><p>CAP子模块配有4个捕捉寄存器CAP_REG0/1/2/3，每个寄存器对应一个捕捉事件CAP_EVNT0/1/2/3，当输入信号满足捕捉事件的特性，则产生捕捉信号CAP_EVNT0/1/2/3，对计数器的数值进行捕捉。</p>
<p>捕捉事件依次按照EVENT0、EVEMT1、EVENT2、EVENT3进行，所以捕捉到的计数器数据依次写入寄存器CAP_REG0、CAP_REG1、CAP_REG2、CAP_REG3。</p>
<p>捕捉状态可以通过寄存器字段CAP_OS_MOD_EN配置为连续捕捉模式或单次捕捉模式。连续捕捉模式，那么从EVENT0执行到EVETN3后，继续从EVENT0执行到EVENT3，按照顺序循环进行。</p>
<p>单次捕捉模式，通过配置寄存器字段CAP_OS_EP配置需要捕捉的事件次数，当从EVENT0执行到所需的事件次数后，CAP子模块不再进行捕获，CAP_REG0/1/2/3寄存器的数据锁存当前数据。</p>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="id10">
<h3><span class="section-number">14.1.2.2.4. </span>简单PWM输出功能<a class="headerlink" href="#id10" title="永久链接至标题">¶</a></h3>
<ol class="arabic">
<li><p>功能框图</p>
<blockquote>
<div><div class="figure align-center" id="id43">
<img alt="../../../_images/pwmoutputblock.png" src="../../../_images/pwmoutputblock.png" />
<p class="caption"><span class="caption-number">图 14.24 </span><span class="caption-text">简易PWM输出功能框图</span><a class="headerlink" href="#id43" title="永久链接至图片">¶</a></p>
</div>
</div></blockquote>
</li>
<li><p>PWM周期以及比较值寄存器</p></li>
</ol>
<p>在简易PWM模式下，寄存器CAP_REG0/1/2/3会做以下的复用：</p>
<ul class="simple">
<li><p>寄存器CAP_REG0作为CAP_CNT_PRD使用，用于设置PWM输出信号的周期值，并且在计数值达到此值的时候，PWM输出的信号设置为高；</p></li>
<li><p>寄存器CAP_REG1作为CAP_CNT_CMP使用，用于设置PWM输出信号的比较值，并且在计数值达到此值的时候，PWM输出的信号设置为低，这样可以调节PWM信号的脉宽；</p></li>
<li><p>寄存器CAP_REG2作为CAP_CNT_PRD的影子寄存器使用，影子寄存器更新的方式是在计数器的数值达到CAP_CNT_PRD的时候更新；</p></li>
<li><p>寄存器CAP_REG3作为CAP_CNT_CMP的影子寄存器使用，影子寄存器更新的方式是在计数器的数值达到CAP_CNT_PRD的时候更新；</p></li>
</ul>
<p>由上可知，对CAP_CNT_PRD写操作，那么CAP_CNT_PRD直接更新，若对影子寄存器CAP_CNT_PRD_SHD写操作，那么在计数器数值达到周期值时才进行更新。CAP_CNT_CMP寄存器的更新方式也是同理。</p>
<p>另外，PWM的输出极性可以利用寄存器CAP_PWM_POL，配置PWM最终输出的极性，即有效电平为高还是低。</p>
</div>
<div class="section" id="id11">
<h3><span class="section-number">14.1.2.2.5. </span>中断信号<a class="headerlink" href="#id11" title="永久链接至标题">¶</a></h3>
<p>CAP子模块的中断信号CAP_INT，由如下图中的信号进行或逻辑产生。另外可以通过寄存器CAP_INT_EN的选择，是否使能对应的信号是否进行或逻辑。</p>
<div class="figure align-center" id="id44">
<img alt="../../../_images/irqsignal.png" src="../../../_images/irqsignal.png" />
<p class="caption"><span class="caption-number">图 14.25 </span><span class="caption-text">CAP子模块的中断信号源</span><a class="headerlink" href="#id44" title="永久链接至图片">¶</a></p>
</div>
</div>
</div>
<div class="section" id="qep">
<h2><span class="section-number">14.1.2.3. </span>QEP子模块<a class="headerlink" href="#qep" title="永久链接至标题">¶</a></h2>
<p>说明：</p>
<ul class="simple">
<li><p>PWM_CNT_CLK_DIV，此文本格式的字段表示为寄存器字段</p></li>
<li><p>PWM_CNT_CLK，此文本格式的字段表示为数字信号</p></li>
</ul>
<div class="section" id="id12">
<h3><span class="section-number">14.1.2.3.1. </span>结构框图<a class="headerlink" href="#id12" title="永久链接至标题">¶</a></h3>
<blockquote>
<div><div class="figure align-center" id="id45">
<img alt="../../../_images/QFP0block.png" src="../../../_images/QFP0block.png" />
<p class="caption"><span class="caption-number">图 14.26 </span><span class="caption-text">QEP0结构框图</span><a class="headerlink" href="#id45" title="永久链接至图片">¶</a></p>
</div>
</div></blockquote>
<p>QEP0子模块主要由Quad Decoder正交解码模块、QEP Position Counter Function位置计数器功能模块、QEP Capture Function正交捕捉模块、QEP Timer定时器、QEP Watchdog Timer看门狗定时器和QEP Interrupt中断模块等构成。</p>
<ul class="simple">
<li><p>Quad Decoder：正交解码模块，用于将正交信号A相、B相进行正交信号的解码，获得后续QEP Position Counter需要的计数时钟QEP_CLK以及计数方向QEP_DIR等信息；</p></li>
<li><p>QEP Position Counter Function：位置计数器功能模块，根据正交解码模块解析的信号进行位置计数器的计数；</p></li>
<li><p>QEP Capture Function：QEP捕捉功能，用于捕捉特定的位置距离的所需要的时间，从而计算转速等信息。</p></li>
<li><p>QEP Timer：QEP定时器，用于产生单位时间间隔的信号</p></li>
<li><p>QEP Watchdog Timer：QEP看门狗定时器。用于检测预设的时间内是否仍有有效QEP_CLK信号</p></li>
<li><p>QEP Interrupt：QEP中断模块，用于产生中断信号。</p></li>
</ul>
</div>
<div class="section" id="id13">
<h3><span class="section-number">14.1.2.3.2. </span>正交解码<a class="headerlink" href="#id13" title="永久链接至标题">¶</a></h3>
<blockquote>
<div><p>通过寄存器字段QEP_DEC_CNT_MODE，可配置解码器工作在四种解码方式</p>
<ul class="simple">
<li><p>QEP_DEC _CNT_MODE = 0x0，正交计数解码</p></li>
<li><p>QEP_DEC _CNT_MODE = 0x1，方向计数解码</p></li>
<li><p>QEP_DEC _CNT_MODE = 0x2，递增计数解码</p></li>
<li><p>QEP_DEC _CNT_MODE = 0x3，递减计数解码</p></li>
</ul>
</div></blockquote>
<ol class="arabic">
<li><p>正交计数解码</p>
<blockquote>
<div><p>正交计数解码方式，外部信号QEP_A和QEP_B输入作为正交信号，根据QEP_A与Q_EPB的信号的相位信息解析出提供后续解码计数器的步进信号QEP_CLK以及步进方向信号QEP_DIR。</p>
<p>图9.30所示为，QEP_A和QEP_B信号组成的相位PH_AB在正向步进以及反向步进的正确跳转，错误的跳转为PH_00与PH_11之间的跳转，以及PH_10和PH_01之间的跳转。</p>
<p>图9.31所示QEP_A和QEP_B的正交计数方式。</p>
<p>正交解码方式</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 22%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>N/A</p></th>
<th class="head" colspan="4"><p>计数器进行+1计数(即产生递增计数)</p></th>
</tr>
<tr class="row-even"><th class="head"></th>
<th class="head"></th>
<th class="head"></th>
<th class="head"></th>
<th class="head"></th>
</tr>
</thead>
<tbody>
<tr class="row-odd"><td><p>QEPA</p></td>
<td><p>上升沿</p></td>
<td><p>下降沿</p></td>
<td><p>高电平</p></td>
<td><p>低电平</p></td>
</tr>
<tr class="row-even"><td><p>QEPB</p></td>
<td><p>低电平</p></td>
<td><p>高电平</p></td>
<td><p>上升沿</p></td>
<td><p>下降沿</p></td>
</tr>
<tr class="row-odd"><td><p>N/A</p></td>
<td colspan="4"><p>计数器进行-1计数(即产生递减计数)</p></td>
</tr>
<tr class="row-even"><td><p>QEPA</p></td>
<td><p>上升沿</p></td>
<td><p>下降沿</p></td>
<td><p>低电平</p></td>
<td><p>高电平</p></td>
</tr>
<tr class="row-odd"><td><p>QEPB</p></td>
<td><p>高电平</p></td>
<td><p>低电平</p></td>
<td><p>上升沿</p></td>
<td><p>下降沿</p></td>
</tr>
</tbody>
</table>
<div class="figure align-center" id="id46">
<img alt="../../../_images/ph_ab.png" src="../../../_images/ph_ab.png" />
<p class="caption"><span class="caption-number">图 14.27 </span><span class="caption-text">正交相位（格式PH_AB）的正向和反向步进</span><a class="headerlink" href="#id46" title="永久链接至图片">¶</a></p>
</div>
<div class="figure align-center" id="id47">
<img alt="../../../_images/decode.png" src="../../../_images/decode.png" />
<p class="caption"><span class="caption-number">图 14.28 </span><span class="caption-text">正交计数解码</span><a class="headerlink" href="#id47" title="永久链接至图片">¶</a></p>
</div>
<p>另外正交计数解码还具有以下的功能：</p>
<ul class="simple">
<li><p>相位异常检测：输入的QEP_A以及QEP_B的相位不符合正常的相位跳转模式，则产生正交信号异常的中断信号QEP_QUADPH_ERR；</p></li>
<li><p>互换功能：通过寄存器字段QEP_SWAP_AB配置为1， 可将QEP_A和QEP_B的输入信号互换。</p></li>
</ul>
</div></blockquote>
</li>
<li><dl>
<dt>方向计数解码</dt><dd><p>方向计数解码方式，则无需经过正交信号的解码，外部信号QEP_A和QEP_B输入分别作为时钟信号QEP_CLK和方向信号QEP_DIR，QEP_DIR决定计数的方向，QEP_CLK用于控制计数的步进。
默认的配置下(即输入信号的极性未进行方向反相)，QEP_DIR为高电平的时候，表示正交计数器进行递增计数，QEP_DIR为低电平的时候，表示正交计数器进行递减计数。
另外QEP_A的信号可以配置为上升沿触发一次QEP_CLK有效边沿，或上下沿均可触发一次的QEP_CLK有效边沿。</p>
<div class="figure align-center" id="id48">
<img alt="../../../_images/coundecode.png" src="../../../_images/coundecode.png" />
<p class="caption"><span class="caption-number">图 14.29 </span><span class="caption-text">方向计数解码（QEP_A用于QEP_CLK，QEP_B用于QEP_DIR）</span><a class="headerlink" href="#id48" title="永久链接至图片">¶</a></p>
</div>
</dd>
</dl>
</li>
<li><p>递增/递减计数解码</p>
<blockquote>
<div><p>此解码方式下，内部信号QEP_DIR固定选定为递增/递减的方向，此时只需QEP_A的输入信号，而QEP_B信号无效。</p>
<p>另外QEP_A的信号可以配置为上升沿触发一次QEP_CLK有效边沿，或上下沿均可触发一次的QEP_CLK有效边沿。</p>
</div></blockquote>
</li>
<li><p>CW/CCW计数解码</p>
<blockquote>
<div><p>CW/CCW计数解码方式包括高有效的CW/CCW解码计数和低有效的CW/CCW解码计数：</p>
<ul class="simple">
<li><p>高有效的CW/CCW解码方式</p></li>
</ul>
<div class="figure align-center" id="id49">
<img alt="../../../_images/highdecode.png" src="../../../_images/highdecode.png" />
<p class="caption"><span class="caption-number">图 14.30 </span><span class="caption-text">高有效的CW/CCW解码计数</span><a class="headerlink" href="#id49" title="永久链接至图片">¶</a></p>
</div>
<p>上图为高有效的CW/CCW的解码计数方式，高有效是指低电平为无效电平，高电平为有效电平，当从低电平跳至高电平产生的上升边沿为有效边沿。若此有效边沿出现在QEP_A信号，即CW信号，那么则位置计数器正向加1；若此有效边沿出现在QEP_B信号，即CCW信号，那么则位置计数器反向减1。</p>
<p>另外如若出现QEP_A和QEP_B同时处于有效电平高电平时，则产生CW/CCW错误中断信号，QEP_CW_CCW_ERR_INT。</p>
<ul class="simple">
<li><p>低有效的CW/CCW解码方式</p></li>
</ul>
<div class="figure align-center" id="id50">
<img alt="../../../_images/lowdecode.png" src="../../../_images/lowdecode.png" />
<p class="caption"><span class="caption-number">图 14.31 </span><span class="caption-text">低有效的CW/CCW解码计数</span><a class="headerlink" href="#id50" title="永久链接至图片">¶</a></p>
</div>
<p>上图为低有效的CW/CCW的解码计数方式，低有效是指高电平为无效电平，低电平为有效电平，当从高电平跳至低电平产生的下降边沿为有效边沿。若此有效边沿出现在QEP_A信号，即CW信号，那么则位置计数器正向加1；若此有效边沿出现在QEP_B信号，即CCW信号，那么则位置计数器反向减1。</p>
<p>另外如若出现QEP_A和QEP_B同时处于有效电平低电平时，则产生CW/CCW错误中断信号，QEP_CW_CCW_ERR_INT。</p>
</div></blockquote>
</li>
<li><p>输入反相</p>
<blockquote>
<div><p>QEP模块的输入信号QEP_A、QEP_B、QEP_I和QEP_S，均可以通过寄存器配置相应的输入反相器是否使能。使能后，输入信号为低有效信号。</p>
</div></blockquote>
</li>
<li><p>输入QEP_IGATE</p>
<blockquote>
<div><p>QEP模块的输入信号QEP_I 可以通过寄存器字段QEP_IGATE配置是否需要使能信号QEP_S对QEP_I进行Gate处理，处理方式如下图。</p>
<div class="figure align-center" id="id51">
<img alt="../../../_images/igate.png" src="../../../_images/igate.png" />
<p class="caption"><span class="caption-number">图 14.32 </span><span class="caption-text">QEP_IGATE控制</span><a class="headerlink" href="#id51" title="永久链接至图片">¶</a></p>
</div>
</div></blockquote>
</li>
<li><p>位置比较输出</p>
<blockquote>
<div><p>QEP Position Counter Function模块输出的信号QEP_SOUT信号，是位置计数器达到寄存器QEP_POS_CNT_CMPV时所产生的信号，该信号输出至正交解码模块，这里可以通过寄存器QEP_SYNC_OUT_PIN选择，使能输出为QEP_I或QEP_S信号。</p>
</div></blockquote>
</li>
<li><p>输入滤波</p>
<blockquote>
<div><p>QEP子模块的信号QEP_A、QEP_B为外部输入信号，支持输入信号的滤波。而QEP子模块的信号QEP_I、QEP_S为双向信号，当设置为输入信号时，同样支持输入信号的滤波。</p>
<p>输入滤波功能，主要是用于滤除噪音信号，功能描述可以参考PWM子模块的 输入滤波 章节描述。</p>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="id14">
<h3><span class="section-number">14.1.2.3.3. </span>正交位置计数功能<a class="headerlink" href="#id14" title="永久链接至标题">¶</a></h3>
<ol class="arabic">
<li><p>功能框图</p>
<blockquote>
<div><div class="figure align-center" id="id52">
<img alt="../../../_images/countblock.png" src="../../../_images/countblock.png" />
<p class="caption"><span class="caption-number">图 14.33 </span><span class="caption-text">正交位置计数功能框图</span><a class="headerlink" href="#id52" title="永久链接至图片">¶</a></p>
</div>
</div></blockquote>
</li>
<li><p>正交位置计数器的复位</p>
<blockquote>
<div><p>通过寄存器字段QEP_POS_CNT_RST，配置正交位置计数器四种复位模式：</p>
<ul class="simple">
<li><p>复位模式1，QEP_POS_CNT_RST = 0x0，QEP_IDX_MKR信号复位位置计数；</p></li>
</ul>
<p>QEP_IDX_MKR信号是表示位置回到0点位置，该信号的产生方式如下：</p>
<ul class="simple">
<li><p>在位置计数器启动，第一次检测到QEP_IDX的有效边沿，此时在QPE_IDX边沿的后续第一个正交信号边沿（若QEP_IDX为与QEP_A、QEP_B Gated的信号，则当前边沿为第一个正交信号边沿）产生QEP_IDX_MKR信号，并且此时记录当前A、B相的边沿（上或下边沿）、产生QEP_FIDX_MKR标记以及锁存此时的方向状态QEP_FIDX_MKR_DIR_FLG。</p></li>
<li><p>接下来继续检测到的QEP_IDX的有效边沿信号，如果此时的方向为正向前进那么在与第一Index Marker相同的边沿产生QEP_IDX_MKR信号；若为反向前进则在相反的边沿产生QEP_IDX_MKR信号。另外，QEP_FIDX_MKR和QEP_FIDX_MKR_DIR_FLG的状态不会再改变，直至QEP模块的复位。</p></li>
</ul>
<p>QEP_IDX_MKR信号复位位置计数的模式下，只要出现QEP_IDX_MKR信号，正交位置计数器则进行一次复位，若为正向前进，那么复位值为0；若为反向前进，则复位值为QEP_POS_CNT_EPV。另外在QEP_IDEX_MKR信号的有效边沿，进行位置计数器的锁存，将当前的QEP_POS_CNT_V数值锁存在QEP_POS_CNT_ICAPV。</p>
<p>另外此模式下，会进行锁存值的判断检测，在正向前进的情况下，如果QEP_IDX_MKR信号触发写入QEP_POS_CNT_ICAPV的数值与的QEP_POS_CNT_EPV数值不一致，那么QEP_POS_CNT_ERR_FLG置1以及QEP_POS_CNT_ERR_INT_FLG置1，表示产生位置计数的错误。</p>
<blockquote>
<div><div class="figure align-center" id="id53">
<img alt="../../../_images/rstcount.png" src="../../../_images/rstcount.png" />
<p class="caption"><span class="caption-number">图 14.34 </span><span class="caption-text">QEP_IDX_MKR信号复位位置计数</span><a class="headerlink" href="#id53" title="永久链接至图片">¶</a></p>
</div>
<div class="figure align-center" id="id54">
<img alt="../../../_images/rstcount1.png" src="../../../_images/rstcount1.png" />
<p class="caption"><span class="caption-number">图 14.35 </span><span class="caption-text">QEP_IDX_MKR信号复位位置计数(A Gated QEP_I)</span><a class="headerlink" href="#id54" title="永久链接至图片">¶</a></p>
</div>
<div class="figure align-center" id="id55">
<img alt="../../../_images/rstcount2.png" src="../../../_images/rstcount2.png" />
<p class="caption"><span class="caption-number">图 14.36 </span><span class="caption-text">QEP_IDX_MKR信号复位位置计数(A &amp; B Gated QEP_I)</span><a class="headerlink" href="#id55" title="永久链接至图片">¶</a></p>
</div>
</div></blockquote>
<ul>
<li><p>复位模式2，QEP_POS_CNT_RST = 0x1，QEP_POS_CNT_EP信号复位位置计数；</p>
<blockquote>
<div><p>QEP_POS_CNT_EP信号，表示的是QEP_POS_CNT_OVFL和QEP_POS_CNT_UNFL进行或逻辑信号。</p>
<p>递增计数时，当计数达到QEP_POS_CNT_EPV时，复位计数器数值为0，同时产生QEP_POS_CNT_OVFL中断信号，指示位置计数器计数上溢出。</p>
<p>递减计数时，当计数达到0时，复位计数器数值为QEP_POS_CNT_EPV，同时产生QEP_POS_CNT_UNFL信号，指示计数器计数下溢出。</p>
</div></blockquote>
</li>
<li><p>复位模式3，QEP_POS_CNT_RST = 0x2，QEP_FIDX_MKR信号复位位置计数；</p>
<blockquote>
<div><p>QEP_FIDX_MKR信号，为QEP模块使能后第一次检测到的QEP_IDX_MKR信号。</p>
<p>此模式下，位置计数器会在QEP_FIDX_MKR信号进行复位，如果为正向前进，那么复位至0，如果为反向则复位至QEP_POS_CNT_EPV。由于后续不会再产生QEP_FIDX_MKR信号，后续的位置计数器复位，通过QEP_POS_CNT_EP信号复位，即按照模式2进行复位。</p>
</div></blockquote>
</li>
<li><p>复位模式4，QEP_POS_CNT_RST = 0x3，QEP_TMR_TO信号复位位置计数；</p>
<blockquote>
<div><p>QEP_TMR_TO信号，为QEP定时器超时的信号。</p>
<p>此模式下，位置计数器会在QEP_TMR_TO信号进行复位，如果为正向前进，那么复位至0，如果为反向则复位至QEP_POS_CNT_EPV。</p>
</div></blockquote>
</li>
</ul>
</div></blockquote>
</li>
<li><p>正交位置计数器的捕获</p>
<blockquote>
<div><p>计数的锁存支持两种，Index相关事件触发的捕获以及Strobe相关事件触发的捕获</p>
<ul>
<li><p>Index相关事件的触发捕获，通过寄存器可选择触发捕获位置计数器的Index事件；</p>
<blockquote>
<div><p>QEP_POS_ICAP_MOD = 0x1，使能QEP_IDX信号的上升沿触发捕获位置计数器，位置计数值QEP_POS_CNT_V写入QEP_POS_CNT_ICAPV；</p>
<p>QEP_POS_ICAP_MOD = 0x2，使能QEP_IDX信号的下降沿触发捕获位置计数器，位置计数值QEP_POS_CNT_V写入QEP_POS_CNT_ICAPV；</p>
<p>QEP_POS_ICAP_MOD = 0x3，使能QEP_IDX_MKR信号触发捕获位置计数器，位置计数值QEP_POS_CNT_V写入QEP_POS_CNT_ICAPV；</p>
</div></blockquote>
</li>
<li><p>Strobe相关事件的触发捕获，通过寄存器可选择触发捕获位置计数器的Strobe事件；</p>
<blockquote>
<div><p>QEP_POS_SCAP_MOD = 0x0，使能QEP_SRB信号的上升沿触发捕获位置计数器，位置计数值QEP_POS_CNT_V写入QEP_POS_CNT_SCAPV；</p>
<p>QEP_POS_SCAP_MOD = 0x1，使能根据方向进行捕获。正向前进时，以QEP_SRB上升沿进行捕获，反向前进时，以QEP_SRB下降沿进行捕获，位置计数值QEP_POS_CNT_V写入QEP_POS_CNT_ICAPV；</p>
</div></blockquote>
</li>
</ul>
</div></blockquote>
</li>
<li><p>正交位置计数器的初始化</p>
<blockquote>
<div><p>位置计数器的初始化支持三种模式的初始化：</p>
<ul>
<li><p>Index相关事件的初始化，通过寄存器可选择触发位置计数器初始化的Index事件；</p>
<blockquote>
<div><p>QEP_POS_IDX_INIT = 0x2，使能QEP_IDX信号的上升沿触发位置计数器的初始化，位置起点值QEP_POS_CNT_SPV写入位置计数器；</p>
<p>QEP_POS_IDX_INIT = 0x3，使能QEP_IDX信号的下降沿触发位置计数器的初始化，位置起点值QEP_POS_CNT_SPV写入位置计数器；</p>
</div></blockquote>
</li>
<li><p>Strobe相关事件的初始化，通过寄存器可选择触发位置计数器初始化的Strobe事件；</p>
<blockquote>
<div><p>QEP_POS_SRB_INIT = 0x2，使能QEP_SRB信号的上升沿触发位置计数器的初始化，位置起点值QEP_POS_CNT_SPV写入位置计数器；</p>
<p>QEP_POS_SRB_INIT = 0x3，使能QEP_SRB信号的下降沿触发位置计数器的初始化，位置起点值QEP_POS_CNT_SPV写入位置计数器；</p>
</div></blockquote>
</li>
<li><p>软件初始化，寄存器QEP_POS_SW_INIT字段置1可触发位置计数器初始化，完成后自动清0。</p></li>
</ul>
</div></blockquote>
</li>
<li><p>QEP_SOUT信号</p>
<blockquote>
<div><p>QEP_SOUT信号，为位置计数器达到QEP_POS_CNT_CMPV的时候产生的信号，此信号只有在QEP_POS_CMP_EN = 1的时候才产生。通过寄存器，QEP_SOUT信号支持极性的控制，以及脉宽长度的调节。</p>
<p>另外寄存器QEP_POS_CNT_CMPV的更新方式支持立即更新以及影子更新模式，影子更细的加载点也可以通过寄存器配置，具体配置见QEP_POS_CMP_LP和QEP_POS_CMP_UPDT_MOD的描述。</p>
<p>QEP_SOUT信号的输出方式见 位置比较 输出章节。</p>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="id15">
<h3><span class="section-number">14.1.2.3.4. </span>正交时间捕捉功能<a class="headerlink" href="#id15" title="永久链接至标题">¶</a></h3>
<div class="figure align-center" id="id56">
<img alt="../../../_images/timeblock.png" src="../../../_images/timeblock.png" />
<p class="caption"><span class="caption-number">图 14.37 </span><span class="caption-text">时间捕捉功能框图</span><a class="headerlink" href="#id56" title="永久链接至图片">¶</a></p>
</div>
<p>时间捕捉功能的框图如上图所示，具体的功能描述如下：</p>
<ul class="simple">
<li><p>SYS_CLK信号输入，利用寄存器字段QEP_CAP_TMR_CLK_DIV进行分频，分频后提供给Capture定时器以及定时器的控制；</p></li>
<li><p>QEP_CLK信号输入，经过Unit Distance Control功能，这里相当于是对QEP_CLK的分频，设定特定的除数，对应就可以获得单位距离的信号QEP_UD_EVNT；</p></li>
<li><p>QEP_UD_EVNT信号触发Capture Control进行对Capture定时器的数值捕获，将QEP_CAP_TMRV的数值写入QEP_CAP_DELT寄存器中，并且复位Capture定时器的计数值为0；</p></li>
<li><p>QEP_TMR_TO信号触发对Timer的寄存器QEP_CAP_TMRV锁存至QEP_CAP_TMR_LH，而QEP_CAP_DELT锁存至QEP_CAP_DELT_LH；</p></li>
<li><p>QEP_DIR输入至方向检测模块，此模块检测在QEP_UD_EVNT的有效边沿间隔中是否出现方向改变的状态，若出现反向改变，QEP_CAP_DERR信号置1；</p></li>
</ul>
<div class="figure align-center" id="id57">
<img alt="../../../_images/capturetimer.png" src="../../../_images/capturetimer.png" />
<p class="caption"><span class="caption-number">图 14.38 </span><span class="caption-text">QEP Capture Timer时间捕获</span><a class="headerlink" href="#id57" title="永久链接至图片">¶</a></p>
</div>
</div>
<div class="section" id="qep-timer">
<h3><span class="section-number">14.1.2.3.5. </span>QEP Timer<a class="headerlink" href="#qep-timer" title="永久链接至标题">¶</a></h3>
<p>QEP Timer的功能框图如下所示，当寄存器QEP_TMR_V的数值大于QEP_TMR_PRD_V时，产生QEP_TMR_TO超时信号。</p>
<div class="figure align-center" id="id58">
<img alt="../../../_images/timerblock.png" src="../../../_images/timerblock.png" />
<p class="caption"><span class="caption-number">图 14.39 </span><span class="caption-text">QEP Timer功能框图</span><a class="headerlink" href="#id58" title="永久链接至图片">¶</a></p>
</div>
</div>
<div class="section" id="qep-watchdog-timer">
<h3><span class="section-number">14.1.2.3.6. </span>QEP Watchdog Timer<a class="headerlink" href="#qep-watchdog-timer" title="永久链接至标题">¶</a></h3>
<p>QEP Watchdog Timer的功能框图如下所示，QEP_CLK信号用于对看门狗定时器的复位，当无有效的QEP_CLK信号出现时，看门狗计时器一直计数，当QEP_WDTMR_V的数值大于QEP_WDTMR_PRD_V时，产生QEP_WDTMR_TO超时信号。</p>
<div class="figure align-center" id="id59">
<img alt="../../../_images/watchdogblock.png" src="../../../_images/watchdogblock.png" />
<p class="caption"><span class="caption-number">图 14.40 </span><span class="caption-text">QEP Watchdog Timer功能框图</span><a class="headerlink" href="#id59" title="永久链接至图片">¶</a></p>
</div>
</div>
<div class="section" id="qep-hall-monitor">
<h3><span class="section-number">14.1.2.3.7. </span>QEP Hall Monitor<a class="headerlink" href="#qep-hall-monitor" title="永久链接至标题">¶</a></h3>
<p>QEP Hall Monitor的功能用于对外部的3路输入信号QEP_HA0/1/2的电平检测：</p>
<ul class="simple">
<li><p>3路的输入信号均配有滤波模块，支持电路的硬件滤波；</p></li>
<li><p>3路的输入信号的电平通过寄存器显示，检测极性配置QEP_HALL_IN_POL = 0时（正极性），0代表低电平，1代表高电平，若为负极性则相反；</p></li>
<li><p>3路的输入信号若由其中一路发生改变，则产生中断，读取状态寄存器QEP_HALL_CHG_FLG可以得出发生信号改变的通道号；</p></li>
</ul>
</div>
<div class="section" id="id16">
<h3><span class="section-number">14.1.2.3.8. </span>中断<a class="headerlink" href="#id16" title="永久链接至标题">¶</a></h3>
<p>QEP模块支持产生中断，通过寄存器可以使能以下的信号经过OR逻辑得出QEP模块的中断信号QEP_INT：</p>
<ul class="simple">
<li><p>QEP_TMRTO</p></li>
</ul>
<p>QEP Timer Timeout信号，指示QEP计数器超时的信号</p>
<ul class="simple">
<li><p>QEP_ICAP</p></li>
</ul>
<p>QEP Index Capture信号，指示发生Index相关事件引起的捕获位置计数器的信号</p>
<ul class="simple">
<li><p>QEP_SCAP</p></li>
</ul>
<p>QEP Strobe Capture信号，指示发生Strobe相关事件引起的捕获位置计数器的信号</p>
<ul class="simple">
<li><p>QEP_POS_CMP</p></li>
</ul>
<p>QEP Position Compare信号，指示产生了位置比较信号</p>
<ul class="simple">
<li><p>QEP_POS_CMP_RDY</p></li>
</ul>
<p>QEP Position Compare Ready信号，指示位置比较寄存器QEP_POS_CNT_CMPV的数值需要更新</p>
<ul class="simple">
<li><p>QEP_POS_CNT_OVFL</p></li>
</ul>
<p>QEP Position Counter Overflow信号，指示位置计数器发生上溢出的信号</p>
<ul class="simple">
<li><p>QEP_POS_CNT_UDFL</p></li>
</ul>
<p>QEP Position Counter Underflow信号，指示位置计数器发生下溢出的信号</p>
<ul class="simple">
<li><p>QEP_WDTO</p></li>
</ul>
<p>QEP Watchdog Timer Timeout信号，指示看门狗计时器发生超时的信号</p>
<ul class="simple">
<li><p>QEP_DIR_CHG</p></li>
</ul>
<p>QEP Direction Change信号，指示QEP的正交解析的方向信号发生了改变</p>
<ul class="simple">
<li><p>QEP_QUADPH_ERR</p></li>
</ul>
<p>QEP Quad Phase Error信号，指示QEP的正交解析的相位信号发生错误</p>
<ul class="simple">
<li><p>QEP_POS_CNT_ERR</p></li>
</ul>
<p>QEP Position Counter Error信号，指示QEP的位置计数器计数出错的信号</p>
<ul class="simple">
<li><p>QEP_CW_CCW_ERR_INT</p></li>
</ul>
<p>QEP CW/CCW Error信号，指示QEP输入的CW和CCW信号出现异常</p>
<ul class="simple">
<li><p>QEP_HALL_INT</p></li>
</ul>
<p>QEP 霍尔输入中断信号，指示QEP输入霍尔信号HA0/1/2的通道中，至少存在一个通道发生输入信号的改变</p>
</div>
</div>
<div class="section" id="id17">
<h2><span class="section-number">14.1.2.4. </span>全局控制<a class="headerlink" href="#id17" title="永久链接至标题">¶</a></h2>
<div class="section" id="id18">
<h3><span class="section-number">14.1.2.4.1. </span>全局时钟控制<a class="headerlink" href="#id18" title="永久链接至标题">¶</a></h3>
<p>PWMCS控制系统的各个模块均具有对时钟源SYS_CLK的使能控制位，详细见寄存器GLB_CLK_CTL。</p>
</div>
<div class="section" id="id19">
<h3><span class="section-number">14.1.2.4.2. </span>全局中断<a class="headerlink" href="#id19" title="永久链接至标题">¶</a></h3>
<p>PWMCS控制系统包括以下的全局中断：</p>
<ul class="simple">
<li><p>PWM全局中断</p></li>
</ul>
<p>PWM子模块PWM_S0/1/…/5各自的中断信号PWM0/1/…/5_INT，进行或逻辑后产生PWM全局中断信号PWM_GLB_INT。通过寄存器GLB_PWM_INT_STS可以查看各个PWM子模块对应的中断信号PWM0/1/…/5_INT的状态。</p>
<ul class="simple">
<li><p>PWM全局故障中断</p></li>
</ul>
<p>PWM子模块PWM_S0/1/…/5各自的故障中断信号PWM0/1/…/5_FLT_INT，进行或逻辑后产生PWM全局故障中断信号PWM_GLB_INT。通过寄存器GLB_PWM_FLT_INT_STS可以查看各个PWM子模块对应的中断信号PWM0/1/…/5_INT的状态。</p>
<ul class="simple">
<li><p>CAP全局中断</p></li>
</ul>
<p>CAP子模块CAP_S0/1/2各自的中断信号CAP0/1/2_FLT_INT，进行或逻辑后产生CAP全局中断信号CAP_GLB_INT。通过寄存器GLB_CAP_INT_STS可以查看各个CAP子模块对应的中断信号CAP0/1/2_INT的状态。</p>
<ul class="simple">
<li><p>QEP全局故障中断</p></li>
</ul>
<p>QEP子模块QEP_S0/1各自的中断信号QEP0/1_FLT_INT，进行或逻辑后产生QEP全局中断信号QEP_GLB_INT。通过寄存器GLB_QEP_INT_STS可以查看各个QEP子模块对应的中断信号QEP0/1_FLT_INT的状态。</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="register.html" class="btn btn-neutral float-right" title="14.1.3. 寄存器描述" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="overview.html" class="btn btn-neutral float-left" title="14.1.1. 概述" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; 版权所有 2023 广州匠芯创科技有限公司.

    </p>
  </div> 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>