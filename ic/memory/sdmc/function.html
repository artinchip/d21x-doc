

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>9.1.2. 功能描述 &mdash; AIC文档中心 v1.0 文档</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme_overrides.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/aic_logo.png"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/translations.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="索引" href="../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../search.html" />
    <link rel="next" title="9.1.3. 编程指南" href="program.html" />
    <link rel="prev" title="9.1.1. 概述" href="overview.html" />
    <script>
        $(function () {
/**
            var $body = $(".rst-content");
            $body.attr("oncontextmenu", "return false"); 
            $body.attr("ondragstart", "return false");
            $body.attr("onselectstart", "return false");
            $body.attr("onbeforecopy", "return false");

            if (document.selection) {
                $body.attr("onselect", "document.selection.empty()");
                $body.attr("oncopy", "document.selection.empty()");
                $body.attr("onmouseup", "document.selection.empty()");
            } else {
                $body.attr("onselect", "document.getSelection().removeAllRanges()");
                $body.attr("oncopy", "document.getSelection().removeAllRanges()");
                $body.attr("onmouseup", "document.getSelection().removeAllRanges()");
            }

            $(".wy-menu-vertical .toctree-l4.current .current.toctree-l5 > ul").wrap("<div></div>");

            $(document).keydown(function (e) {
                var $div = $(".wy-menu-vertical .toctree-l4.current .current.toctree-l5 > div");
                var scrollLeft = $div.scrollLeft();
                var step = 50;
                var code = e.keyCode;
                switch (code) {
                    case 37:
                        $div.scrollLeft(scrollLeft - step);
                        break;
                    case 39:
                        $div.scrollLeft(scrollLeft + step);
                        break;
                    case 65:
                    case 67:
                    case 83:
                    case 86:
                        var ctrlKey = navigator.platform.match("Mac") ? e.metaKey : e.ctrlKey;
                        if (ctrlKey) {
                            e.preventDefault();
                            window.event.returnValue = false;
                        }
                        break;
                    case 123:
                        e.preventDefault();
                        window.event.returnValue = false;
                        break;
                }
	    });  **/

            watermark({
                watermark_id: ".wy-nav-content",
                watermark_txt: "ArtInChip",
                watermark_font: "微软雅黑",
                watermark_fontsize: "100px",
                watermark_width: 600,
                watermark_height: 300,
                watermark_alpha: 0.1,
                watermark_rows: 0,
                watermark_y: 100,
                watermark_x_space: 0,
                watermark_y_space: 100
            });

        });

        function watermark(settings) {
            var defaultSettings = {
                watermark_id: "body",
                watermark_txt: "text",
                watermark_x: 20,
                watermark_y: 20,
                watermark_rows: 20,
                watermark_cols: 20,
                watermark_x_space: 100,
                watermark_y_space: 50,
                watermark_color: '#aaa',
                watermark_alpha: 0.4,
                watermark_fontsize: '15px',
                watermark_font: 'Times New Roman',
                watermark_width: 210,
                watermark_height: 80,
                watermark_angle: 20
            };

            for (key in settings) {
                defaultSettings[key] = settings[key];
            }

            var oTemp = document.createDocumentFragment();

            var $container = $(defaultSettings.watermark_id);

            var page_width = $container.width();
            var col_width = defaultSettings.watermark_width + defaultSettings.watermark_x_space;
            defaultSettings.watermark_cols = page_width / col_width;

            var page_height = $container.height();
            var row_height = defaultSettings.watermark_height + defaultSettings.watermark_y_space;
            defaultSettings.watermark_rows = page_height / row_height;

            var x, y;
            for (var i = 0; i < defaultSettings.watermark_rows; i++) {
                y = defaultSettings.watermark_y + (defaultSettings.watermark_y_space + defaultSettings.watermark_height) * i;
                for (var j = 0; j < defaultSettings.watermark_cols; j++) {
                    x = defaultSettings.watermark_x + (defaultSettings.watermark_width + defaultSettings.watermark_x_space) * j;
                    var mask_div = document.createElement('div');
                    mask_div.id = 'mask_div' + i + j;
                    mask_div.className = 'mask_div';
                    mask_div.appendChild(document.createTextNode(defaultSettings.watermark_txt));

                    mask_div.style.webkitTransform = "rotate(-" + defaultSettings.watermark_angle + "deg)";
                    mask_div.style.MozTransform = "rotate(-" + defaultSettings.watermark_angle + "deg)";
                    mask_div.style.msTransform = "rotate(-" + defaultSettings.watermark_angle + "deg)";
                    mask_div.style.OTransform = "rotate(-" + defaultSettings.watermark_angle + "deg)";
                    mask_div.style.transform = "rotate(-" + defaultSettings.watermark_angle + "deg)";
                    mask_div.style.visibility = "";
                    mask_div.style.position = "absolute";
                    mask_div.style.left = x + 'px';
                    mask_div.style.top = y + 'px';
                    mask_div.style.overflow = "hidden";
                    mask_div.style.zIndex = "9999";

                    mask_div.style.pointerEvents = 'none';
                    mask_div.style.opacity = defaultSettings.watermark_alpha;
                    mask_div.style.fontSize = defaultSettings.watermark_fontsize;
                    mask_div.style.fontFamily = defaultSettings.watermark_font;
                    mask_div.style.color = defaultSettings.watermark_color;
                    mask_div.style.textAlign = "center";
                    mask_div.style.width = defaultSettings.watermark_width + 'px';
                    mask_div.style.height = defaultSettings.watermark_height + 'px';
                    mask_div.style.display = "block";
                    oTemp.appendChild(mask_div);
                };
            };
            $container.append(oTemp);
        }
    </script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> AIC文档中心
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../product/index.html">产品简介</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../quick-start/index.html">快速入门</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../datasheet/index.html">数据手册</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">芯片手册</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../about/index.html">1. 文档说明</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../introduction/index.html">2. 产品描述</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../memory_maps/index.html">3. 地址映射</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../pinmux/index.html">4. 引脚复用</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cpu_bus/index.html">5. 处理器和总线</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../security/index.html">6. 安全</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../brom/index.html">7. 启动</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../clocks_power/index.html">8. 时钟和电源</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">9. 存储</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="index.html">9.1. Secure Digital Host Controller (SDMC)</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="overview.html">9.1.1. 概述</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">9.1.2. 功能描述</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#id2">9.1.2.1. 总线接口模块</a></li>
<li class="toctree-l5"><a class="reference internal" href="#dma">9.1.2.2. 内部DMA控制器</a></li>
<li class="toctree-l5"><a class="reference internal" href="#id3">9.1.2.3. 卡接口模块</a></li>
<li class="toctree-l5"><a class="reference internal" href="#id4">9.1.2.4. 时钟和时序</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="program.html">9.1.3. 编程指南</a></li>
<li class="toctree-l4"><a class="reference internal" href="register.html">9.1.4. 寄存器描述</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../media/index.html">10. 多媒体</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../timers/index.html">11. 计时器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../interface/index.html">12. 接口</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../analog/index.html">13. 模拟</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../svo/index.html">14. 伺服系统</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../verify/index.html">15. 验证</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../hw/index.html">硬件指南</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../luban/index.html">Linux SDK</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../lite/index.html">RTOS SDK</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../baremetal/index.html">Baremetal</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tools/index.html">工具指南</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../3rdapp/index.html">三方应用</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../aboutus/index.html">关于我们</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">AIC文档中心</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">芯片手册</a> &raquo;</li>
        
          <li><a href="../index.html"><span class="section-number">9. </span>存储</a> &raquo;</li>
        
          <li><a href="index.html"><span class="section-number">9.1. </span>SDMC</a> &raquo;</li>
        
      <li><span class="section-number">9.1.2. </span>功能描述</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="id1">
<h1><span class="section-number">9.1.2. </span>功能描述<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h1>
<div class="section" id="id2">
<h2><span class="section-number">9.1.2.1. </span>总线接口模块<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<p><strong>AHB从机接口</strong></p>
<p>通过AHB接口访问Host控制器，控制器内部使用AHB从机接口连接AHB主机。</p>
<p>当使用AHB总线访问寄存器时，每笔寄存器访问都需要等待一个时钟周期。</p>
<p>当使用AHB访问数据FIFO时:</p>
<ul class="simple">
<li><p>对于单笔传输方式，每笔传输需要等待一个时钟周期；</p></li>
<li><p>对于突发传输方式，访问第一个数据需要等待一个时钟周期，接下来的访问则不用等待。</p></li>
</ul>
<p>在访问FIFO区域的部分数据时，当被访问的数据地址与FIFO地址对齐时，FIFO数据才会发生pop或push操作。
例如，如果FIFO数据位宽为32位，</p>
<ul class="simple">
<li><p>当访问32位数据时，FIFO直接发生pop或push操作；</p></li>
<li><p>当访问16位数据时，地址线[0]=1时，发生pop或push操作；</p></li>
<li><p>当访问8位数据时，地址线[1:0]=11b时，发生pop或push操作。</p></li>
</ul>
<p>对于部分写操作，数据先存储在临时寄存器内，直到FIFO数据地址与FIFO地址对齐时，才真正写入FIFO。
因此，建议对FIFO进行全位宽访问。如果需要进行部分位宽访问，一定要优先访问低字节位。</p>
<p><strong>寄存器单元</strong></p>
<p>寄存器单元是总线接口模块的一部分，它提供了寄存器的读写访问功能。控制器最大支持的总线位宽为64bits，
本芯片寄存器设计为32bits位宽。除了TCBC和TFBC寄存器以外，其他的寄存器都可以选择访问8/16/32位宽，
这由Host总线接口位宽和byte_enable控制信号共同决定。</p>
<p>所有的寄存器都属于HIF时钟域。当一个命令发送到Card，应设置CMD寄存器的start_bit位，
所有需要CIF操作的相关寄存器发送到CIF模块。此时，从HIF到CIF的寄存器不能被写入。
再次写入这些寄存器之前，软件应该等待硬件清零start bit位。寄存器单元具有硬件锁功能，防止非法写入寄存器。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p><strong>一旦start_bit置位，还没有硬件清零时，以下寄存器不能再次写入：</strong></p>
</div>
<ul class="simple">
<li><p>CMD</p></li>
<li><p>CMDARG</p></li>
<li><p>CLK_CTRL</p></li>
<li><p>TMOUT</p></li>
<li><p>BUS_WIDTH</p></li>
</ul>
<p><strong>中断控制单元</strong></p>
<p>中断控制单元产生中断信号，该信号由控制器的初始中断状态寄存器，中断使能寄存器，以及全局中断使能寄存器位决定。
一旦某个中断条件被检测到，初始中断状态寄存器对应的中断位会置1。初始中断状态位保持，直到通过软件写1清零。</p>
<p><strong>FIFO控制单元</strong></p>
<p>FIFO控制器连接内部FIFO到Host接口，以及卡控制器单元。FIFO深度为128，FIFO位宽为32位。由于读和写传输不会同时发生，
可以使用一个共享FIFO用于读写传输，以节省芯片面积。因为允许使用部分总线位宽访问FIFO，
此时会使用临时寄存器先存储低字节数据，直到高字节数据到来时才真正访问FIFO。</p>
<p><strong>卡检测单元</strong></p>
<p>卡检测单元用于检测SD卡插入和拔出时信号电平变化。通过一个去抖计时器来延迟检测时间，避免由于机械插拔造成的信号抖动，
并产生一个中断信号发送给Host。用户可以通过编程Debounce寄存器设置去抖时间。上电后，控制器读取卡检测端口的状态值并将其存储到内存里，
每次检测的状态值都与之前的状态值进行异或并更新到Card_detect_n寄存器。</p>
<p>卡检测信号连接到卡座上，需要进行外部上拉，当没有卡插入时检测到高电平，Card_detect_n寄存器置1；当检测到卡插入，该检测脚通过卡座连接到地，
检测到低电平，Card_detect_n寄存器为0。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p><strong>只有SDMC1控制器支持硬件卡检测模块，其他控制器可以通过GPIO进行卡检测。</strong></p>
</div>
</div>
<div class="section" id="dma">
<h2><span class="section-number">9.1.2.2. </span>内部DMA控制器<a class="headerlink" href="#dma" title="永久链接至标题">¶</a></h2>
<p>内部DMA控制器（IDMAC）由控制寄存器，状态寄存器，和单向发送/接收引擎组成。控制器使用一个有效的描述符
将数据从源地址搬移到目标地址，使CPU干预最小化。IDMAC和Host驱动之间的通信使用单个数据结构，
IDMAC从Card接收数据存储到Host内部的数据缓存，从数据缓存读取数据发送到FIFO。存储在Host内部的描述符，
作为指针指向这些数据缓存。</p>
<p>在Host内部物理存储空间包含一个数据缓存区，它由完整数据或部分数据组成。该缓存区仅包含数据，
缓存的状态包含在描述符中。数据链是指数据跨多个数据缓存。然而，单个描述符不会跨多个数据。</p>
<p>单个描述符用于接收和发送数据。链表的基址写入描述符链表基址寄存器（IDMASADDR）。描述符链表向前连接，
最后一个描述符可以指回到第一个描述符，形成一个环状结构。描述符链表属于Host物理内存地址空间。
每个描述符可以指向两个数据缓存中最大的一个。</p>
<p>通过配置HCTRL1寄存器的bit25，使能或禁用IDMAC。如果IDMAC被禁用，可以通过AHB总线的Slave接口访问数据。
如果IDMAC使能，则不能通过Slave接口访问FIFO。</p>
<p><strong>描述符</strong></p>
<p>IDMAC使用两种描述符结构：</p>
<ul class="simple">
<li><p>双缓存结构：两个描述符的间隔，通过PBUSCFG寄存器的DSL位域进行编程。</p></li>
<li><p>链式结构：每个描述符指向唯一的缓存和下一个描述符地址。</p></li>
</ul>
<p>两种描述符结构见下图：</p>
<div class="figure align-center">
<img alt="../../../_images/sdmc_des.png" src="../../../_images/sdmc_des.png" />
</div>
<p>描述符地址必须按照32位数据位宽对齐，每个描述符包含16字节的控制和状态信息，由4个DES寄存器组成，每个DES都存储32位数据。</p>
<p>DES0用于配置控制信息，说明如下：</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 6%" />
<col style="width: 34%" />
<col style="width: 60%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>位域</p></th>
<th class="head"><p>位域名称</p></th>
<th class="head"><p>说明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>31</p></td>
<td><p>OWN</p></td>
<td><div class="line-block">
<div class="line">该位置1，表示描述符由IDMA控制。当该位复位，表示描述符由Host控制。</div>
<div class="line">当数据传输完成时，IDMA控制器对该位清零。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>30</p></td>
<td><p>CES(Card Error Summary)</p></td>
<td><div class="line-block">
<div class="line">该错误位表示发送到Card和来自Card的状态，该位也存在于OINTST</div>
<div class="line">寄存器，与以下位域为逻辑或的关系：</div>
<div class="line">BE：结束位错误</div>
<div class="line">TO：响应超时</div>
<div class="line">CRC：响应数据CRC错误</div>
<div class="line">RTO：数据读超时</div>
<div class="line">CRC：数据接收CRC错误</div>
<div class="line">RE：响应错误</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p>29:6</p></td>
<td><p>RESET</p></td>
<td><div class="line-block">
<div class="line">/</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>5</p></td>
<td><p>ER(End of Ring)</p></td>
<td><div class="line-block">
<div class="line">该位置1，表示描述符链表到达最后一个描述符。</div>
<div class="line">IDMA控制器返回链表的基址，创建一个描述符环。</div>
<div class="line">仅在双缓存描述符结构时有效。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p>4</p></td>
<td><p>CH(Second Address Chained)</p></td>
<td><div class="line-block">
<div class="line">该位置1，表示描述符的第二个地址是下一个描述符的地址，不是第二个缓存</div>
<div class="line">的地址。该位置1时，DES1[25:13]应该清零。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>3</p></td>
<td><p>FS(Fist Descriptor)</p></td>
<td><div class="line-block">
<div class="line">该位置1，表示描述符包含第一个缓存的数据。如果第一个缓存的容量为0，</div>
<div class="line">下一个描述符包含起始数据。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>LD(Last Descriptor)</p></td>
<td><div class="line-block">
<div class="line">该位与一次DMA传输的最后一个block有关。</div>
<div class="line">该位置1，表示缓存指向该描述符的最后一个缓存数据。该描述符结束后，</div>
<div class="line">剩余的字节数为0。即描述符完成后且该位置1时，剩余字节数为0。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>DIC(Disable Interrupt on Completion)</p></td>
<td><div class="line-block">
<div class="line">该位置1，防止IDMA状态寄存器的TI/RI位置1。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p>0</p></td>
<td><p>RES</p></td>
<td><div class="line-block">
<div class="line">/</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>DES1用于配置每个描述符的数据长度，说明如下：</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 6%" />
<col style="width: 17%" />
<col style="width: 76%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>位域</p></th>
<th class="head"><p>位域名称</p></th>
<th class="head"><p>说明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>31:26</p></td>
<td><p>RES</p></td>
<td><div class="line-block">
<div class="line">/</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>25:13</p></td>
<td><p>BS2(Buffer 2 Size)</p></td>
<td><div class="line-block">
<div class="line">缓存2容量</div>
<div class="line">该位表示第二数据缓存的字节容量。缓存容量一定是2的整数倍，对应总线位宽。</div>
<div class="line">如果缓存容量不是2的整数倍，会造成未定义的结果。</div>
<div class="line">如果该位域为0，DMA忽略该缓存，跳到下一个双缓存结构的缓存。</div>
<div class="line">对于链式结构，该位域是无效的；此时DES0[4]置1。如果在任意的描述符里该位被设置为0，</div>
<div class="line">那么剩下的描述符不能为非零值，直到最后一个描述符。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p>12:0</p></td>
<td><p>BS1(Buffer 1 Size)</p></td>
<td><div class="line-block">
<div class="line">缓存1容量</div>
<div class="line">表示数据缓存的字节容量，它一定是2的整数倍，对应总线位宽。</div>
<div class="line">如果缓存容量不是2的整数倍，会造成未定义的结果。该位域不能为0。</div>
<div class="line"><strong>注意：如果仅有一个缓存被编程，必须使用缓存1，而不是缓存2.</strong></div>
</div>
</td>
</tr>
</tbody>
</table>
<p>DES2用于配置第一个描述符的起始地址，说明如下：</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 6%" />
<col style="width: 15%" />
<col style="width: 80%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>位域</p></th>
<th class="head"><p>位域名称</p></th>
<th class="head"><p>说明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>31:0</p></td>
<td><p>缓存地址指针1</p></td>
<td><div class="line-block">
<div class="line">当使用双缓存结构时，该位表示第一个数据缓存的物理地址。对于链式结构，该位域表示数据缓存的物理地址。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>DES3用于配置下一个描述符的起始地址，说明如下：</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 3%" />
<col style="width: 8%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>位域</p></th>
<th class="head"><p>位域名称</p></th>
<th class="head"><p>说明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>31:0</p></td>
<td><p>缓存地址指针2</p></td>
<td><div class="line-block">
<div class="line">当使用双缓存结构时，该位域表示第二个缓存的物理地址。如果DES0[4]置1，该地址指向下一个描述符的地址。如果不是最后一个描述符，下一个描述符的地址一定要总线位宽对齐，即bit[2:0]为0，对应总线位宽为64/32/16，内部最低有效位被忽略。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><strong>IDMA控制器初始化</strong></p>
<ol class="arabic simple">
<li><p>写IDMAC总线模式寄存器（PBUSCFG），设置Host总线访问参数；</p></li>
<li><p>写IDMAC中断使能寄存器（IDMAINTEN），屏蔽掉不需要的中断；</p></li>
<li><p>驱动软件创建发送或接收的描述符链表，并写入IDMAC描述符链表基址寄存器（IDMASADDR），为IDMAC提供起始地址；</p></li>
<li><p>IDMAC模块从描述符链表获取描述符。</p></li>
</ol>
</div>
<div class="section" id="id3">
<h2><span class="section-number">9.1.2.3. </span>卡接口模块<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<p>卡接口模块连接总线接口模块和SD/MMC Card或SDIO设备。Host向HIF的控制寄存器写入命令参数，这些参数发送到CIF。
根据控制寄存器的值，CIF生成命令和数据，根据不同的设备协议，在响应的总线上进行传输。
为了使CIF正确的工作，软件必须满足如下要求：</p>
<ul class="simple">
<li><p>对于命令和数据传输，同一时间仅选择一个Card；</p></li>
<li><p>同一时间仅能发送一个命令；</p></li>
<li><p>对于开放式的写操作，如果因为FIFO为空Card时钟停止了，软件必须向FIFO填满数据，才能启动时钟；</p></li>
<li><p>对于SDIO传输，如果Card功能挂起，软件想要恢复挂起的传输，在发送新的数据传输命令时，必须复位FIFO并发送恢复命令；</p></li>
<li><p>当Card正在处理数据传输时，发送卡复位命令（CMD0，CMD15或CMD52），软件必须设置命令寄存器的stop_abort_cmd位，确保发送复位命令之前先停止数据传输；</p></li>
<li><p>当OINTST寄存器的EBE置位，控制器不能保证SDIO中断。软件应该忽略SDIO中断，发送停止或丢弃命令给Card，确保Card停止发送读数据；</p></li>
<li><p>在读数据时，如果Card时钟因为FIFO满而停止，软件应该继续读至少两个FIFO地址，再启动Card时钟。</p></li>
</ul>
<p>CIF模块主要包括命令通路，数据通路，SDIO中断控制，时钟控制，复用/去复用单元等，框图如下：</p>
<div class="figure align-center">
<img alt="../../../_images/sdmc_cif_block.png" src="../../../_images/sdmc_cif_block.png" />
</div>
<p><strong>命令通道</strong></p>
<p>主要功能：</p>
<ul class="simple">
<li><p>加载时钟参数</p></li>
<li><p>加载Card命令参数</p></li>
<li><p>发送命令到Card总线</p></li>
<li><p>从Card总线接收设备响应</p></li>
<li><p>发送响应到HIF</p></li>
</ul>
<p>通过对HIF寄存器编程发送一个新的命令，将命令寄存器的start_cmd位置1。HIF的start_cmd有效，表示新的命令被发送。
命令通路加载新的命令，并发送一个应答信号给HIF，此时cmd_taken信号有效。</p>
<p>命令加载后，命令通路的状态机发送命令给SD/MMC总线，包括内部产生的CRC7校验码，并接收Device返回的响应数据。
然后，状态机发送接收的响应数据和命令完成的信号（CCS）给HIF，并等待8个时钟周期，再加载新的命令。</p>
<p><strong>数据通道</strong></p>
<p>数据通路模块在写数据时，从FIFO中取出数据通过cdata_out发送数据；在接收数据时，通过cdata_in将接收到的数据送入FIFO。
数据通路加载新的数据参数，包括是否传输数据，读或写数据传输方向，流传输或块传输方式，数据块容量，字节数量，Card类型，超时时间等。</p>
<p>如果命令寄存器的data_expected位置1，新的传输命令会根据如下情况在数据通道执行：</p>
<ul class="simple">
<li><p>如果read/write位为1，发送数据；</p></li>
<li><p>如果read/write位为0，接收数据；</p></li>
</ul>
<p><strong>SDIO中断控制</strong></p>
<p>SDIO设备的中断请求报告给HIF，经过两个时钟周期，中断信号有效。SDIO设备在中断周期内通过保持cdata_in为低有效产生中断信号。
通过中断控制状态机决定被选择的设备工作在中断周期内。对于不活动或未选择的设备，或工作在1位数据模式下，中断周期总是有效的。
对于工作在宽总线模式，活跃的或被选中的设备需要满足以下条件，中断周期才是有效的：</p>
<ul class="simple">
<li><p>设备空闲时产生中断；</p></li>
<li><p>没有正在处理的数据传输命令时产生中断；</p></li>
<li><p>在两个数据块之间的结束位之后的第三个时钟产生中断；</p></li>
<li><p>上一笔数据结束位之后的两个时钟到下一笔数据命令的结束位期间产生中断。</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p><strong>当Card数据总线为4位时，在以下情况下，控制器不会采样被选中卡的SDIO中断。因为SDIO中断为电平触发，它需要在一个中断周期内进行采样，host才不会丢失任何来自卡的中断。</strong></p>
</div>
<p>读或写恢复：CIF将恢复命令当作正常的数据传输命令处理。SDIO中断在恢复命令处理时，与其他数据命令类似。
根据SDIO协议，对于正常的数据命令，在命令结束位之后中断周期结束。对于恢复命令，在响应结束位之后中断周期结束。
在恢复命令的结束位之后，停止中断采样。</p>
<p>读数据期间挂起：如果读数据传输被Host挂起，Host将abort_read_data位置1并复位数据状态机。
在CIF中，从恢复命令响应到abort_read_data位置1期间，SDIO中断不会被采样。
在Host将abort_read_data位置1后，SDIO中断被处理，启动中断采样。</p>
<p><strong>时钟控制</strong></p>
<p>时钟控制模块提供了不同的时钟频率来满足SD/MMC不同速度模式下的频率要求。cclk_in信号是源时钟（频率大于等于Card最大工作时钟频率），
它经过时钟分频器分频。源时钟用于产生不同的Card时钟频率cclk_out。每个Card时钟可以拥有不同的时钟频率，
因为SD Card可以是低速卡或高速卡。每个Card都提供了一个时钟信号，允许每个卡工作在不同的时钟频率。</p>
<p><strong>错误检测</strong></p>
<p>响应错误：</p>
<ul class="simple">
<li><p>响应超时：计时器到达超时寄存器配置的超时时间后，未接收到响应的起始位。</p></li>
<li><p>响应CRC错误：收到期望的响应并检查响应数据的CRC校验码，响应数据中的CRC7校验码与内部生成的校验码不匹配。</p></li>
<li><p>响应错误：响应的传输位不为0，命令序列与发送的命令序列不匹配，或响应的结束位不为1。</p></li>
</ul>
<p>数据发送错误：</p>
<ul class="simple">
<li><p>无CRC状态信号：在一个写数据期间，如果在数据块发出之后的2个时钟周期后，CRC状态信号的起始位没有接收到，产生无CRC状态的错误。</p></li>
<li><p>无效的CRC：如果在写数据块发送之后产生无效的CRC状态（非010），一个数据CRC错误信号会发送到HIF，数据传输继续进行。</p></li>
<li><p>由于FIFO为空造成的Data Starvation：如果在写数据时FIFO为空，或Card时钟停止且数据超时后FIFO剩余的数据为空，一个data-starvation信号会发送到HIF单元，数据通道继续等待数据进入FIFO。</p></li>
</ul>
<p>数据接收错误：</p>
<ul class="simple">
<li><p>数据超时：在读数据时，如果计时器到达超时时间后，没有接收到数据的起始位，会发生数据超时错误。</p></li>
<li><p>数据起始位错误：在4位或8位模式读数据时，如果发生起始位错误，应用程序必须发送CMD12或CMD52结束错误状态。在命令接收完成后，应用程序必须复位IDMAC和CIF，并清除错误状态。发送任意的数据传输命令之前FIFO必须复位。</p></li>
<li><p>数据CRC错误：在读数据块传输期间，如果接受到的CRC16校验码与内部产生的CRC16校验码不匹配，数据通道发送数据CRC错误的信号给HIF，继续传输数据。</p></li>
<li><p>数据结束位错误：在读数据期间，如果接收到的数据结束位不为1，数据通道发送end-bit错误信号给HIF，并终止数据传输，该信号发送HIF则数据传输完成。</p></li>
<li><p>由于FIFO满造成的Data starvation：在读数据传输期间，当FIFO为满，Card时钟停止。如果FIFO满并且数据超时，data starvation错误信号发送到HIF（此时OINTST寄存器的Host-Timeout位置1），数据通道继续等待FIFO变为空。</p></li>
<li><p>如果在读操作时Card时钟因为FIFO满而停止，Host控制器不能正确的采样到数据。</p></li>
</ul>
</div>
<div class="section" id="id4">
<h2><span class="section-number">9.1.2.4. </span>时钟和时序<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h2>
<p><strong>时钟域</strong></p>
<p>在控制器内部，有多种不同的时钟域，各个时钟域之间的关系描述如下：</p>
<ul class="simple">
<li><p>clk-系统/Host/AHB总线时钟：HIF模块使用该时钟，所有的配置寄存器使用该时钟。</p></li>
<li><p>cclk_in-输入时钟：CIF模块大部分模块和寄存器工作在该时钟的上升沿，时钟Gate信号用来Gate输出到卡的时钟，使用输入时钟的下降沿进行Gate。</p></li>
<li><p>cclk_in_drv-驱动时钟：输入时钟经过相位移动和延迟单元输出的驱动时钟，用于数据和命令的输出驱动。该时钟用来满足不同速度模式下保持时间的要求。</p></li>
<li><p>cclk_in_sample-采样时钟：输入时钟经过相位移动和延迟单元输出的采样时钟，用于数据和命令接收采样。</p></li>
<li><p>cclk_out-输出时钟：由cclk_in分频后输出给卡的工作时钟。</p></li>
</ul>
<p>控制器时钟域框图如下：</p>
<div class="figure align-center">
<img alt="../../../_images/sdmc_clock_domain.png" src="../../../_images/sdmc_clock_domain.png" />
</div>
<p><strong>延时控制</strong></p>
<p>由于控制器内部由多种不同的时钟组成，输出驱动时钟和采样时钟需要经过一个相移器和延迟单元进行延迟，以满足不同速度等级的SD/MMC设备稳定的工作时序要求。
因此，需要在Host控制器外部实现相移和延迟电路。结构框图如下：</p>
<div class="figure align-center">
<img alt="../../../_images/sdmc_delay_chain.png" src="../../../_images/sdmc_delay_chain.png" />
</div>
<p>在CMU模块对PLL_FRA0进行分频，输入到Host控制器的模块时钟频率最大为200MHz，经过时钟选择复用器选择控制器输入时钟，再经过内部时钟分频器clk_divider0进行分频后输出，
以满足不同的速度等级要求，共有3种选择：</p>
<ul class="simple">
<li><p>2b’00：25MHz，对应速度模式：DS，HS-SDR，HS-DDR</p></li>
<li><p>2b’01：50MHz，对应速度模式：HS，HS-SDR，HS-DDR</p></li>
<li><p>2b’10：100MHz，对应速度模式：HS-DDR</p></li>
</ul>
<p>速度模式等级说明：</p>
<ul class="simple">
<li><p>DS：SD卡默认速度模式，工作电平3.3V，工作频率0~25MHz，最大传输速率25Mbps；</p></li>
<li><p>HS：SD卡高速模式，工作电平3.3V，工作频率0~50MHz，最大传输速率50Mbps；</p></li>
<li><p>HS-SDR：eMMC高速SDR模式，工作电平3.3V，工作频率0~50MHz，最大传输速率50Mbps；</p></li>
<li><p>HS-DDR：eMMC高速DDR模式，工作电平3.3V，工作频率0~50MHz，最大传输速率100Mbps。</p></li>
</ul>
<p>经过时钟复用器选择后，进入移相器，共有4种相位可编程：0°，90°，180°，270°。每个相位之后再经过一级Delay Chain进行32级的延迟，
Delay Chain内部由若干个延时单元组成，每个延时单元的延时时间相同。未经过相位延迟和delay chain的时钟作为控制器的输入时钟cclk_in，
经过控制器内部的分频器分频输出cclk_out，作为外设的接口时钟。用户可以通过SMC_DLYCTRL寄存器对时钟相位，Delay Chain进行编程选择。</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="program.html" class="btn btn-neutral float-right" title="9.1.3. 编程指南" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="overview.html" class="btn btn-neutral float-left" title="9.1.1. 概述" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; 版权所有 2023 广州匠芯创科技有限公司.

    </p>
  </div> 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>