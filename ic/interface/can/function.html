

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>12.7.2. 功能描述 &mdash; AIC文档中心 v1.0 文档</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme_overrides.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/aic_logo.png"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/translations.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="索引" href="../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../search.html" />
    <link rel="next" title="12.7.3. 编程指南" href="program.html" />
    <link rel="prev" title="12.7.1. 概述" href="overview.html" />
    <script>
        $(function () {
/**
            var $body = $(".rst-content");
            $body.attr("oncontextmenu", "return false"); 
            $body.attr("ondragstart", "return false");
            $body.attr("onselectstart", "return false");
            $body.attr("onbeforecopy", "return false");

            if (document.selection) {
                $body.attr("onselect", "document.selection.empty()");
                $body.attr("oncopy", "document.selection.empty()");
                $body.attr("onmouseup", "document.selection.empty()");
            } else {
                $body.attr("onselect", "document.getSelection().removeAllRanges()");
                $body.attr("oncopy", "document.getSelection().removeAllRanges()");
                $body.attr("onmouseup", "document.getSelection().removeAllRanges()");
            }

            $(".wy-menu-vertical .toctree-l4.current .current.toctree-l5 > ul").wrap("<div></div>");

            $(document).keydown(function (e) {
                var $div = $(".wy-menu-vertical .toctree-l4.current .current.toctree-l5 > div");
                var scrollLeft = $div.scrollLeft();
                var step = 50;
                var code = e.keyCode;
                switch (code) {
                    case 37:
                        $div.scrollLeft(scrollLeft - step);
                        break;
                    case 39:
                        $div.scrollLeft(scrollLeft + step);
                        break;
                    case 65:
                    case 67:
                    case 83:
                    case 86:
                        var ctrlKey = navigator.platform.match("Mac") ? e.metaKey : e.ctrlKey;
                        if (ctrlKey) {
                            e.preventDefault();
                            window.event.returnValue = false;
                        }
                        break;
                    case 123:
                        e.preventDefault();
                        window.event.returnValue = false;
                        break;
                }
	    });  **/

            watermark({
                watermark_id: ".wy-nav-content",
                watermark_txt: "ArtInChip",
                watermark_font: "微软雅黑",
                watermark_fontsize: "100px",
                watermark_width: 600,
                watermark_height: 300,
                watermark_alpha: 0.1,
                watermark_rows: 0,
                watermark_y: 100,
                watermark_x_space: 0,
                watermark_y_space: 100
            });

        });

        function watermark(settings) {
            var defaultSettings = {
                watermark_id: "body",
                watermark_txt: "text",
                watermark_x: 20,
                watermark_y: 20,
                watermark_rows: 20,
                watermark_cols: 20,
                watermark_x_space: 100,
                watermark_y_space: 50,
                watermark_color: '#aaa',
                watermark_alpha: 0.4,
                watermark_fontsize: '15px',
                watermark_font: 'Times New Roman',
                watermark_width: 210,
                watermark_height: 80,
                watermark_angle: 20
            };

            for (key in settings) {
                defaultSettings[key] = settings[key];
            }

            var oTemp = document.createDocumentFragment();

            var $container = $(defaultSettings.watermark_id);

            var page_width = $container.width();
            var col_width = defaultSettings.watermark_width + defaultSettings.watermark_x_space;
            defaultSettings.watermark_cols = page_width / col_width;

            var page_height = $container.height();
            var row_height = defaultSettings.watermark_height + defaultSettings.watermark_y_space;
            defaultSettings.watermark_rows = page_height / row_height;

            var x, y;
            for (var i = 0; i < defaultSettings.watermark_rows; i++) {
                y = defaultSettings.watermark_y + (defaultSettings.watermark_y_space + defaultSettings.watermark_height) * i;
                for (var j = 0; j < defaultSettings.watermark_cols; j++) {
                    x = defaultSettings.watermark_x + (defaultSettings.watermark_width + defaultSettings.watermark_x_space) * j;
                    var mask_div = document.createElement('div');
                    mask_div.id = 'mask_div' + i + j;
                    mask_div.className = 'mask_div';
                    mask_div.appendChild(document.createTextNode(defaultSettings.watermark_txt));

                    mask_div.style.webkitTransform = "rotate(-" + defaultSettings.watermark_angle + "deg)";
                    mask_div.style.MozTransform = "rotate(-" + defaultSettings.watermark_angle + "deg)";
                    mask_div.style.msTransform = "rotate(-" + defaultSettings.watermark_angle + "deg)";
                    mask_div.style.OTransform = "rotate(-" + defaultSettings.watermark_angle + "deg)";
                    mask_div.style.transform = "rotate(-" + defaultSettings.watermark_angle + "deg)";
                    mask_div.style.visibility = "";
                    mask_div.style.position = "absolute";
                    mask_div.style.left = x + 'px';
                    mask_div.style.top = y + 'px';
                    mask_div.style.overflow = "hidden";
                    mask_div.style.zIndex = "9999";

                    mask_div.style.pointerEvents = 'none';
                    mask_div.style.opacity = defaultSettings.watermark_alpha;
                    mask_div.style.fontSize = defaultSettings.watermark_fontsize;
                    mask_div.style.fontFamily = defaultSettings.watermark_font;
                    mask_div.style.color = defaultSettings.watermark_color;
                    mask_div.style.textAlign = "center";
                    mask_div.style.width = defaultSettings.watermark_width + 'px';
                    mask_div.style.height = defaultSettings.watermark_height + 'px';
                    mask_div.style.display = "block";
                    oTemp.appendChild(mask_div);
                };
            };
            $container.append(oTemp);
        }
    </script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> AIC文档中心
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../product/index.html">产品简介</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../quick-start/index.html">快速入门</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../datasheet/index.html">数据手册</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">芯片手册</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../about/index.html">1. 文档说明</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../introduction/index.html">2. 产品描述</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../memory_maps/index.html">3. 地址映射</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../pinmux/index.html">4. 引脚复用</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cpu_bus/index.html">5. 处理器和总线</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../security/index.html">6. 安全</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../brom/index.html">7. 启动</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../clocks_power/index.html">8. 时钟和电源</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../memory/index.html">9. 存储</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../media/index.html">10. 多媒体</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../timers/index.html">11. 计时器</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">12. 接口</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../usbdev/index.html">12.1. USB Device (USBDEV)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../usbhost/index.html">12.2. USB Host (USBHOST)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mac/index.html">12.3. Media Access Control (MAC)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../qspi/index.html">12.4. Quad Serial Peripheral Interface (QSPI)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../uart/index.html">12.5. Universal Asynchronous Receiver/Transmitter (UART)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../i2c/index.html">12.6. Inter Integrated Circuit (I2C)</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">12.7. Controller Area Network (CAN)</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="overview.html">12.7.1. 概述</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">12.7.2. 功能描述</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#id2">12.7.2.1. 典型应用</a></li>
<li class="toctree-l5"><a class="reference internal" href="#id3">12.7.2.2. 运行模式</a></li>
<li class="toctree-l5"><a class="reference internal" href="#id4">12.7.2.3. 位时序</a></li>
<li class="toctree-l5"><a class="reference internal" href="#id5">12.7.2.4. 通信报文</a></li>
<li class="toctree-l5"><a class="reference internal" href="#id6">12.7.2.5. 中断管理</a></li>
<li class="toctree-l5"><a class="reference internal" href="#id7">12.7.2.6. 数据缓冲器</a></li>
<li class="toctree-l5"><a class="reference internal" href="#ref-to-filter">12.7.2.7. 接收过滤器</a></li>
<li class="toctree-l5"><a class="reference internal" href="#id9">12.7.2.8. 错误管理</a></li>
<li class="toctree-l5"><a class="reference internal" href="#id10">12.7.2.9. 错误捕获</a></li>
<li class="toctree-l5"><a class="reference internal" href="#id11">12.7.2.10. 仲裁丢失捕获</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="program.html">12.7.3. 编程指南</a></li>
<li class="toctree-l4"><a class="reference internal" href="register.html">12.7.4. 寄存器定义</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../cir/index.html">12.8. Consumer Infrared Radiation (CIR)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pbus/index.html">12.9. Parallel Bus (PBUS)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../gpio/index.html">12.10. General Purpose Input Output (GPIO)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../analog/index.html">13. 模拟</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../svo/index.html">14. 伺服系统</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../verify/index.html">15. 验证</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../hw/index.html">硬件指南</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../luban/index.html">Linux SDK</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../lite/index.html">RTOS SDK</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../baremetal/index.html">Baremetal</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tools/index.html">工具指南</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../3rdapp/index.html">三方应用</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../aboutus/index.html">关于我们</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">AIC文档中心</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">芯片手册</a> &raquo;</li>
        
          <li><a href="../index.html"><span class="section-number">12. </span>接口</a> &raquo;</li>
        
          <li><a href="index.html"><span class="section-number">12.7. </span>CAN</a> &raquo;</li>
        
      <li><span class="section-number">12.7.2. </span>功能描述</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="id1">
<h1><span class="section-number">12.7.2. </span>功能描述<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h1>
<div class="section" id="id2">
<h2><span class="section-number">12.7.2.1. </span>典型应用<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<ul class="simple">
<li><p>CAN典型应用如 <a class="reference internal" href="#can-application"><span class="std std-numref">图 12.41</span></a> 所示：</p></li>
</ul>
<div class="figure align-center" id="id12">
<span id="can-application"></span><img alt="../../../_images/02_can_application.png" src="../../../_images/02_can_application.png" />
<p class="caption"><span class="caption-number">图 12.41 </span><span class="caption-text">CAN典型应用</span><a class="headerlink" href="#id12" title="永久链接至图片">¶</a></p>
</div>
</div>
<div class="section" id="id3">
<h2><span class="section-number">12.7.2.2. </span>运行模式<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<ul>
<li><p>控制器包含5种运行模式，由模式寄存器（CAN_MODE）定义设置。</p>
<blockquote>
<div><ul class="simple">
<li><p>复位模式：Reset Mode，进入复位模式，控制器离线不参与总线任何活动，可修改CAN控制器的各种参数配置。退出复位模式后，控制器需等待11 个连续隐性位出现(等效于总线空闲)，才能正常接收和发送报文。</p></li>
<li><p>正常模式： Normal Mode，CAN 控制器可以发送和接收包含错误信号在内的报文。</p></li>
<li><p>自测模式：Self-Test Mode, 与正常模式相同，但在该模式下，CAN 控制器发送报文时，即使没有接收到应答，也不会产生应答错误。通常在控制器自测时使用该模式。</p></li>
<li><p>只听模式： Listen Only Mode，CAN 控制器可以接收报文，但在CAN 总线上保持完全被动。因此，CAN 控制器将无法发送任何报文、应答或错误信号，错误计数将保持冻结状态。该模式用于CAN 总线监控。</p></li>
<li><p>休眠模式：Sleep Mode，无总线活动及无中断发生，可进入低功耗休眠模式，该模式下时钟停止。SLEEP_MOD为0或总线有信号输入时唤醒，产生唤醒中断。</p></li>
</ul>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="id4">
<h2><span class="section-number">12.7.2.3. </span>位时序<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h2>
<ul>
<li><p>为了实现位同步，每个正常位时间划分为几个不重叠时间的片段，包括同步段SS，传播段PS，相位缓冲段PBS1，相位缓冲段PBS2，一个完整的位由8~25个时间定额Tq组成。</p>
<blockquote>
<div><ul class="simple">
<li><p>如 <a class="reference internal" href="#can-timing"><span class="std std-numref">图 12.42</span></a> 所示，将传播段PS和相位缓冲段PBS1合并形成新的时间段Ts1。</p></li>
<li><p>在复位模式下，配置总线时序0寄存器（CAN_BTR0）和总线时序1寄存器（CAN_BTR1）中的BRP、SJW、TS1、TS2、SAM等参数，决定CAN的波特率。</p></li>
<li><p>SJW具体作用是增大或减小CAN波特率的容许偏差量，其大小与波特率值没有太大关系，可理解为波特率精度调节，SJW值越大则总线获得更宽波特率容忍度。</p></li>
</ul>
</div></blockquote>
</li>
</ul>
<div class="figure align-center" id="id13">
<span id="can-timing"></span><img alt="../../../_images/03_can_timing.png" src="../../../_images/03_can_timing.png" />
<p class="caption"><span class="caption-number">图 12.42 </span><span class="caption-text">CAN位时序</span><a class="headerlink" href="#id13" title="永久链接至图片">¶</a></p>
</div>
<ul>
<li><p>位时序各参数计算关系如下：</p>
<blockquote>
<div><ul class="simple">
<li><p>时间定额Tq = 2*(BRP[5:0]+1)*Tpclk，其中Tpclk为APB时钟（通常为24MHz）周期。</p></li>
<li><p>位时间Tbit = [1+ (TS1+1) + (TS2+1)]*Tq；</p></li>
<li><p>波特率Baud = 1/Tbit；</p></li>
<li><p>采样点= [1 + (TS1+1)]/ [1+ (TS1+1) + (TS2+1)]。</p></li>
<li><p>举例：假设单次采样SAM为0，且SJW=2，TS1=8，TS2=1，BRP=0，则波特率为24M/[2*(0+1)*(1+9+2)]=1Mbps，采样点为(1+9)/ (1+9+2)=83%。建议选取规则：TS2&gt;=SJW；BRP尽量小、SJW尽量大；采样点选取范围75%~85%之间；尽量采用单次采样。</p></li>
</ul>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="id5">
<h2><span class="section-number">12.7.2.4. </span>通信报文<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h2>
<ul class="simple">
<li><p>CAN通信报文类型包含数据帧、远程帧、错误帧、过载帧、间隔帧这5种类型。</p></li>
</ul>
<div class="figure align-center" id="id14">
<img alt="../../../_images/04_can_data_frame.png" src="../../../_images/04_can_data_frame.png" />
<p class="caption"><span class="caption-number">图 12.43 </span><span class="caption-text">CAN标准格式和扩展格式数据帧</span><a class="headerlink" href="#id14" title="永久链接至图片">¶</a></p>
</div>
<div class="figure align-center" id="id15">
<img alt="../../../_images/05_can_remote_frame.png" src="../../../_images/05_can_remote_frame.png" />
<p class="caption"><span class="caption-number">图 12.44 </span><span class="caption-text">CAN标准格式和扩展格式远程帧</span><a class="headerlink" href="#id15" title="永久链接至图片">¶</a></p>
</div>
<div class="figure align-center" id="id16">
<img alt="../../../_images/06_can_err.png" src="../../../_images/06_can_err.png" />
<p class="caption"><span class="caption-number">图 12.45 </span><span class="caption-text">CAN错误帧、过载帧、间隔帧</span><a class="headerlink" href="#id16" title="永久链接至图片">¶</a></p>
</div>
<table class="colwidths-given docutils align-center" id="id17">
<caption><span class="caption-number">表 12.6 </span><span class="caption-text">数据帧/远程帧描述</span><a class="headerlink" href="#id17" title="永久链接至表格">¶</a></caption>
<colgroup>
<col style="width: 19%" />
<col style="width: 81%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>数据/远程帧</p></th>
<th class="head"><p>描述</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>SOF</p></td>
<td><div class="line-block">
<div class="line">帧起始，1bit，用于同步总线上节点的单个显性位。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>ID-A</p></td>
<td><div class="line-block">
<div class="line">标识符A，11bit，对应标准格式中的11位标识符（ID10~ ID0），或扩展格式中29位</div>
<div class="line">标识符的前11bit（ID28~ ID18）</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p>RTR</p></td>
<td><div class="line-block">
<div class="line">远程发送请求位，1bit，显示当前报文是数据帧（显性0）还是远程帧（隐性1）。</div>
<div class="line">这意味着，当某个数据帧和远程帧有相同标识符时，数据帧始终优先于远程帧仲裁。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>SRTR</p></td>
<td><div class="line-block">
<div class="line">代替远程发送请求位，1bit，在扩展格式中以替代标准格式相同位置的RTR 位</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p>IDE</p></td>
<td><div class="line-block">
<div class="line">标识符扩展位，1bit，显示当前报文是标准格式（显性0）还是扩展格式（隐性1）。</div>
<div class="line">这意味着，当某标准帧和扩展帧有相同基标识符时，标准帧将始终优先于扩展帧仲裁。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>ID-B</p></td>
<td><div class="line-block">
<div class="line">标识符B，18bit，扩展格式中29位标识符的剩余18bit（ID17 ~ ID0）</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p>R1</p></td>
<td><div class="line-block">
<div class="line">保留位，始终是显性位</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>R0</p></td>
<td><div class="line-block">
<div class="line">保留位，始终是显性位</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p>DLC</p></td>
<td><div class="line-block">
<div class="line">数据长度代码， 4bit，包含0 ~ 8 中任一数值。数据帧用于表示包含的数据字节数量。</div>
<div class="line">远程帧用于表示从其他节点请求的数据字节数量。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>数据字节</p></td>
<td><div class="line-block">
<div class="line">表示数据帧的数据负载量，该字节数量应与DLC的值匹配。首先发送数据字节0，</div>
<div class="line">各数据字节优先发送最高有效位。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p>CRC</p></td>
<td><div class="line-block">
<div class="line">CRC序列是一个15-bit的循环冗余校验码。具体实现方式为：被除多项式的系数由</div>
<div class="line">SOF、仲裁场、控制场、数据场（若存在）及15位（最低系数）0组成的未经填充的</div>
<div class="line">位流给定，而生成多项式为X15+X14+X10+X8+X7+X4+X3+X0，被除多项式被生成</div>
<div class="line">多项式除（按模2计算），余数即为将要发送到总线上的CRC序列。发送节点和</div>
<div class="line">接收节点均采用相同方法生成CRC校验码，并与发送节点送出的CRC校验码进行比较，</div>
<div class="line">若出错，控制器依据仲裁原则及受损报文优先原则对已损坏报文自动重发。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>CRC分界符</p></td>
<td><div class="line-block">
<div class="line">分界符，1bit隐性位</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p>ASK槽</p></td>
<td><div class="line-block">
<div class="line">应答槽，1bit，用于接收节点，表示是否已成功接收数据帧或远程帧。发送节点将在</div>
<div class="line">应答槽中发送一个隐性位，若接收到的帧无错误，则接收节点用一个显性位以示应答。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>ASK分界符</p></td>
<td><div class="line-block">
<div class="line">分界符，1bit隐性位</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p>EOF</p></td>
<td><div class="line-block">
<div class="line">帧结束，7bit隐性位，标志着数据帧或远程帧的结束。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id6">
<h2><span class="section-number">12.7.2.5. </span>中断管理<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h2>
<ul>
<li><p>控制器提供8种中断包括总线错误中断、仲裁丢失中断、被动错误中断、唤醒中断、数据溢出中断、错误报警中断、发送中断、接收中断。</p>
<blockquote>
<div><ul class="simple">
<li><p>由中断寄存器（CAN_INTR）定义，通过设置中断使能寄存器（CAN_INTEN）中相应使能位，每个中断源都可以单独允许和禁用。</p></li>
<li><p>当有一个或多个中断触发，控制器IRQ有效，当所有中断位都被清除，控制器IRQ失效。</p></li>
<li><p>中断寄存器被读取后，除接收中断外，其中的中断位将自动清除。</p></li>
<li><p>接收中断直到通过RXB_REL 指令位清除所有接收报文后，才能被清除，否则会影响接收缓冲状态RXB_STAT。</p></li>
</ul>
</div></blockquote>
</li>
<li><p>接收中断RX_INT：当接收FIFO 中有待读取报文（接收数据计数寄存器（CAN_RXC）中RXC &gt; 0）时触发此中断。计数的报文数量包括有效报文和溢出报文。直到通过RXB_REL 指令位清除所有挂起接收报文后，接收中断才会失效。</p></li>
<li><p>发送中断TX_INT：当发送缓冲器空闲，将其他报文加载到缓冲器中等待发送时，都会触发此中断。</p></li>
<li><p>错误报警中断ERRW_INT：状态寄存器（CAN_STAT）中ERR_STAT或BUS_STAT的位值发生改变（由0变1或由1变0）都会触发此中断。触发时状态值可分以下几种：</p>
<blockquote>
<div><ul class="simple">
<li><p>ERR_STAT = 0 与BUS_STAT = 0：如果控制器处于主动错误状态，则表示TEC 和REC 的值都返回ERRWT 所设阈值之下；如果控制器此前处于总线恢复状态，则表示此时总线恢复已成功完成。</p></li>
<li><p>ERR_STAT = 1 与BUS_STAT = 0：表示TEC 或REC 数值已超过ERRWT所设阈值。</p></li>
<li><p>ERR_STAT = 1 与BUS_STAT = 1：表示控制器已进入离线状态（TEC&gt; =255）。</p></li>
<li><p>ERR_STAT = 0 与BUS_STAT = 1：表示总线恢复期间，控制器TEC 数值已低于ERRWT所设阈值。</p></li>
</ul>
</div></blockquote>
</li>
<li><p>仲裁丢失中断ARBLOST_INT ：控制器发送报文并且丢失仲裁时触发此中断。丢失仲裁位置将被捕获记录在状态寄存器（CAN_STAT）的ARBLOST_CAP中，状态被清除之前（通过CPU 的读取），将不会再记录新的仲裁丢失位置。</p></li>
<li><p>总线错误中断ERRB_INT：控制器在总线上检测到错误时触发此中断。错误类型和错误位置都将被捕获记录在状态寄存器（CAN_STAT）的ERR_TYPE和ERR_CODE中。状态被清除之前（通过CPU 的读取），将不会再记录新的总线错误信息。</p></li>
</ul>
</div>
<div class="section" id="id7">
<h2><span class="section-number">12.7.2.6. </span>数据缓冲器<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h2>
<ul class="simple">
<li><p>下表描述了数据缓冲寄存器布局。发送和接收缓冲寄存器的访问地址范围相同（0x40~0x70），且只有当控制器处于非复位模式时才可访问。</p></li>
</ul>
<table class="colwidths-given docutils align-center" id="id18">
<caption><span class="caption-number">表 12.7 </span><span class="caption-text">数据缓冲寄存器布局</span><a class="headerlink" href="#id18" title="永久链接至表格">¶</a></caption>
<colgroup>
<col style="width: 17%" />
<col style="width: 23%" />
<col style="width: 30%" />
<col style="width: 30%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>寄存器</p></th>
<th class="head"><p>偏移地址</p></th>
<th class="head"><p>标准格式内容</p></th>
<th class="head"><p>扩展格式内容</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>CAN_BUF0</p></td>
<td><p>0x40</p></td>
<td><p>TX/RX 帧信息</p></td>
<td><p>TX/RX 帧信息</p></td>
</tr>
<tr class="row-odd"><td><p>CAN_BUF1</p></td>
<td><p>0x44</p></td>
<td><p>TX/RX 标识符1</p></td>
<td><p>TX/RX 标识符1</p></td>
</tr>
<tr class="row-even"><td><p>CAN_BUF2</p></td>
<td><p>0x48</p></td>
<td><p>TX/RX 标识符2</p></td>
<td><p>TX/RX 标识符2</p></td>
</tr>
<tr class="row-odd"><td><p>CAN_BUF3</p></td>
<td><p>0x4C</p></td>
<td><p>TX/RX 数据1</p></td>
<td><p>TX/RX 标识符3</p></td>
</tr>
<tr class="row-even"><td><p>CAN_BUF4</p></td>
<td><p>0x50</p></td>
<td><p>TX/RX 数据2</p></td>
<td><p>TX/RX 标识符4</p></td>
</tr>
<tr class="row-odd"><td><p>CAN_BUF5</p></td>
<td><p>0x54</p></td>
<td><p>TX/RX 数据3</p></td>
<td><p>TX/RX 数据1</p></td>
</tr>
<tr class="row-even"><td><p>CAN_BUF6</p></td>
<td><p>0x58</p></td>
<td><p>TX/RX 数据4</p></td>
<td><p>TX/RX 数据2</p></td>
</tr>
<tr class="row-odd"><td><p>CAN_BUF7</p></td>
<td><p>0x5C</p></td>
<td><p>TX/RX 数据5</p></td>
<td><p>TX/RX 数据3</p></td>
</tr>
<tr class="row-even"><td><p>CAN_BUF8</p></td>
<td><p>0x60</p></td>
<td><p>TX/RX 数据6</p></td>
<td><p>TX/RX 数据4</p></td>
</tr>
<tr class="row-odd"><td><p>CAN_BUF9</p></td>
<td><p>0x64</p></td>
<td><p>TX/RX 数据7</p></td>
<td><p>TX/RX 数据5</p></td>
</tr>
<tr class="row-even"><td><p>CAN_BUF10</p></td>
<td><p>0x68</p></td>
<td><p>TX/RX 数据8</p></td>
<td><p>TX/RX 数据6</p></td>
</tr>
<tr class="row-odd"><td><p>CAN_BUF11</p></td>
<td><p>0x6C</p></td>
<td><p>保留</p></td>
<td><p>TX/RX 数据7</p></td>
</tr>
<tr class="row-even"><td><p>CAN_BUF12</p></td>
<td><p>0x70</p></td>
<td><p>保留</p></td>
<td><p>TX/RX 数据8</p></td>
</tr>
</tbody>
</table>
<ul>
<li><p>发送缓冲寄存器：CPU 的写入操作访问，配置待发送报文，指定报文的帧类型、帧格式、帧标识符和数据。CPU通过控制寄存器（CAN_MCR）配置发送报文模式：</p>
<blockquote>
<div><ul class="simple">
<li><p>正常报文发送，需将TX_REQ置1。</p></li>
<li><p>自发自收，需将SELF_REQ 置1。</p></li>
<li><p>单次发送，需将TX_REQ 和ABORT_REQ同时置1。</p></li>
</ul>
</div></blockquote>
</li>
<li><p>接收缓冲寄存器：CPU 的读取操作访问，接收缓冲寄存器映射到缓冲FIFO 中的第一条报文，获取第一条报文的帧类型、帧格式、帧标识符和数据。读取完接收缓冲寄存器中的报文后，CPU 通过控制寄存器（CAN_MCR）中的RXB_REL置1来释放接收缓冲寄存器，若接收FIFO 中仍有待处理的报文，按照接收报文的先后次序将最早接收到的报文映射到接收缓冲寄存器中。</p></li>
<li><p>缓冲FIFO： 是一个64字节大小的内部缓冲器，以先进先出原则存储接收到的报文。接收缓冲寄存器为FIFO中可访问窗口，偏移地址0x40~0x70，将被映射到FIFO 中第一条报文，一条报文可在FIFO 中占3 ~ 13字节空间，其中字节序与接收缓冲寄存器相同。当控制器接收到一条报文时，接收数据计数器RXC增加1，最大值为64。如果FIFO中有足够空间，报文内容将被写入到FIFO 中。首先，CPU读取接收缓冲寄存器中的报文后，通过将RXB_REL置1，释放FIFO 中第一条报文所占的空间， RXC将减小1。然后，接收缓冲寄存器将映射FIFO 中的下一条报文。</p></li>
<li><p>FIFO数据溢出：在任何情况下，FIFO 中可以存储的报文数量取决于各条报文的长度，当FIFO 中没有足够空间完整地存储新的报文，控制器会产生数据溢出，通过状态位或数据溢出中断反馈给CPU。FIFO在内部将溢出报文标记为无效，后续接收到的溢出报文仍然将增加RXC 到最大值64。为了清除FIFO 中的溢出报文，应重复调用RXB_REL，直到RXC为0。这样可以读取接收FIFO 中的所有有效报文，并清除所有溢出报文。</p></li>
</ul>
<div class="figure align-center" id="id19">
<img alt="../../../_images/07_can_fifo.png" src="../../../_images/07_can_fifo.png" />
<p class="caption"><span class="caption-number">图 12.46 </span><span class="caption-text">CAN缓冲FIFO存储报文过程</span><a class="headerlink" href="#id19" title="永久链接至图片">¶</a></p>
</div>
</div>
<div class="section" id="ref-to-filter">
<span id="id8"></span><h2><span class="section-number">12.7.2.7. </span>接收过滤器<a class="headerlink" href="#ref-to-filter" title="永久链接至标题">¶</a></h2>
<ul class="simple">
<li><p>接收过滤器，是一个可编程的报文过滤单元，允许控制器根据报文的标识符、帧类型、第一个数据字节接收或拒绝该报文，由4个接收代码寄存器（CAN_RXCODE）和4个接收屏蔽寄存器（CAN_RXMASK）定义组成。</p></li>
<li><p>如 <a class="reference internal" href="#can-mask"><span class="std std-numref">图 12.47</span></a> 所示，每条报文中的位必须匹配RXCODE 值所指定的模式或者被RXMASK值屏蔽，才能使该报文通过过滤并存储到接收FIFO中。</p></li>
<li><p>接收代码寄存器、接收屏蔽寄存器，分别与缓冲0~3寄存器（偏移地址0x40~0x4C）、缓冲4~7寄存器（偏移地址0x50~5C）地址空间相同，所以只有控制器在复位模式时，才能访问这两个寄存器。</p></li>
</ul>
<div class="figure align-center" id="id20">
<span id="can-mask"></span><img alt="../../../_images/08_can_mask.png" src="../../../_images/08_can_mask.png" />
<p class="caption"><span class="caption-number">图 12.47 </span><span class="caption-text">接收过滤器原理</span><a class="headerlink" href="#id20" title="永久链接至图片">¶</a></p>
</div>
<ul class="simple">
<li><p>单过滤模式：在模式寄存器（CAN_MODE）中将FILTER_SEL设置为1启动单过滤模式。根据RXCODE / RXMASK的值定义单个过滤器，其定义及过滤报文格式如图1-11所示。</p></li>
</ul>
<div class="figure align-center" id="id21">
<img alt="../../../_images/09_can_single.png" src="../../../_images/09_can_single.png" />
<p class="caption"><span class="caption-number">图 12.48 </span><span class="caption-text">单过滤模式下单个过滤器定义及其可过滤报文格式</span><a class="headerlink" href="#id21" title="永久链接至图片">¶</a></p>
</div>
<ul class="simple">
<li><p>双过滤模式：在模式寄存器（CAN_MODE）中将FILTER_SEL设置为0启动双过滤模式。根据RXCODE / RXMASK的值将定义2个过滤器，分别为过滤器0和过滤器1，其标准格式和扩展格式下过滤报文定义如图1-12和图1-13所示。双过滤模式下，如果报文通过这2个滤波器中至少一个，则表示该报文成功通过过滤。</p></li>
</ul>
<div class="figure align-center" id="id22">
<img alt="../../../_images/10_can_dual_std.png" src="../../../_images/10_can_dual_std.png" />
<p class="caption"><span class="caption-number">图 12.49 </span><span class="caption-text">双过滤模式下SFF标准格式过滤报文定义</span><a class="headerlink" href="#id22" title="永久链接至图片">¶</a></p>
</div>
<div class="figure align-center" id="id23">
<img alt="../../../_images/11_can_dual_ext.png" src="../../../_images/11_can_dual_ext.png" />
<p class="caption"><span class="caption-number">图 12.50 </span><span class="caption-text">双过滤模式下EFF扩展格式过滤报文定义</span><a class="headerlink" href="#id23" title="永久链接至图片">¶</a></p>
</div>
</div>
<div class="section" id="id9">
<h2><span class="section-number">12.7.2.8. </span>错误管理<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h2>
<ul class="simple">
<li><p>错误计数包含发送错误计数TEC和接收错误计数REC，错误计数将决定CAN控制器当前的错误状态（如主动错误、被动错误、离线）。</p></li>
<li><p>除了错误状态外，控制器还提供错误报警阈值ERRWT功能，这个功能可在控制器进入被动错误状态前，提醒用户当前发生的严重总线错误。</p></li>
<li><p>控制器当前的错误状态通过TEC、REC、ERR_STAT 、BUS _STAT和ERRWT体现，这些数值和状态位的变化将触发中断，从而提醒用户当前的错误状态变化（参考中断管理）。</p></li>
</ul>
<div class="figure align-center" id="id24">
<span id="can-errsta"></span><img alt="../../../_images/12_can_errsta.png" src="../../../_images/12_can_errsta.png" />
<p class="caption"><span class="caption-number">图 12.51 </span><span class="caption-text">错误状态变化及中断关系</span><a class="headerlink" href="#id24" title="永久链接至图片">¶</a></p>
</div>
<ul>
<li><p>如 <a class="reference internal" href="#can-errsta"><span class="std std-numref">图 12.51</span></a> 所示为错误状态、计数数值、状态位以及相关中断之间的关系。</p>
<blockquote>
<div><ul class="simple">
<li><p>错误报警阈值ERRWT将作为报警功能提示当前发生的总线错误，且在控制器进入被动错误状态之前被触发。在复位模式下，ERRWT数值可在错误报警阈值寄存器（CAN_ERRWT）中进行配置。当TEC和/或REC数值大于等于ERRWT时，ERR_STAT 被置1。当TEC 和REC 数值都小于ERRWT时， ERR_STAT被复位0。只要ERR_STAT或BUS_STAT位值发生变化，便会触发错误报警中断ERRW_INT。</p></li>
<li><p>当TEC和/或REC数值大于127 时，节点进入被动错误状态。当TEC和REC数值都小于等于127时，节点重新变为主动错误状态。节点在主动错误和被动错误状态之间切换时，都将触发被动错误中断ERRP_INT。</p></li>
<li><p>当TEC 数值大于255 时，节点进入总线关闭离线状态。此时，控制器将REC数值置为0、TEC数值置为127、BUS_STAT位置1、产生错误报警中断ERRW_INT、控制器进入复位模式。</p></li>
<li><p>为了返回主动错误状态，必须进行离线恢复。首先需要退出复位模式，进入正常操作模式；然后要求节点在总线上检测到128 次11 个连续隐性位。每一次检测到11 个连续隐性位时，TEC 数值都将减1，当离线恢复完成后（TEC 数值从127 减小到0），BUS_STAT位复位为0，从而触发错误报警中断ERRW_INT。</p></li>
</ul>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="id10">
<h2><span class="section-number">12.7.2.9. </span>错误捕获<a class="headerlink" href="#id10" title="永久链接至标题">¶</a></h2>
<ul class="simple">
<li><p>错误捕获功能允许控制器以错误代码的形式，记录总线错误类型和错误位置。</p></li>
<li><p>当检测到一个总线错误时，总线错误中断ERRB_INT将被触发，相应的错误代码将记录在状态寄存器（CAN_STAT）的ERR_CODE中。</p></li>
<li><p>在当前错误代码被读取前，后续的总线错误中断触发时，将不会再记录。</p></li>
</ul>
</div>
<div class="section" id="id11">
<h2><span class="section-number">12.7.2.10. </span>仲裁丢失捕获<a class="headerlink" href="#id11" title="永久链接至标题">¶</a></h2>
<ul class="simple">
<li><p>仲裁丢失捕捉功能允许控制器记录仲裁丢失的bit位置。</p></li>
<li><p>当控制器丢失仲裁时，所丢失bit位置将被记录在状态寄存器（CAN_STAT）的ARBLOST_CAP中，同时触发仲裁丢失中断ARBLOST_INT。</p></li>
<li><p>在当前仲裁丢失捕获bit位置被读取前，后续的仲裁丢失中断触发时，将不会再记录。</p></li>
</ul>
<div class="figure align-center" id="id25">
<img alt="../../../_images/13_can_arblost.png" src="../../../_images/13_can_arblost.png" />
<p class="caption"><span class="caption-number">图 12.52 </span><span class="caption-text">仲裁丢失位置记录</span><a class="headerlink" href="#id25" title="永久链接至图片">¶</a></p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="program.html" class="btn btn-neutral float-right" title="12.7.3. 编程指南" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="overview.html" class="btn btn-neutral float-left" title="12.7.1. 概述" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; 版权所有 2023 广州匠芯创科技有限公司.

    </p>
  </div> 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>